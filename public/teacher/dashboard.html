<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>FLED - Teacher Dashboard</title>

  <!-- Favicons -->
  <link href="../assets/img/favicon.png" rel="icon">
  <link href="../assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="../assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="../assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="../assets/vendor/aos/aos.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="../assets/css/main.css" rel="stylesheet">
  
  <style>
    /* Enhanced Dashboard Styles */
    .dashboard.section {
      padding: 4rem 0;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      min-height: 100vh;
    }
    
    .section-title {
      text-align: center;
      margin-bottom: 3rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .section-title h2 {
      background: linear-gradient(135deg, #71c55d 0%, #5ba649 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
      font-size: 2.5rem;
      margin: 0;
    }
    
    /* Enhanced Modal Styles */
    .modal-content {
      border: none;
      border-radius: 16px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
      background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
    }

    .modal-header {
      background: linear-gradient(135deg, #71c55d 0%, #5ba649 100%);
      color: white;
      border-radius: 16px 16px 0 0;
      padding: 1.5rem 2rem;
      border-bottom: none;
    }

    .modal-header .modal-title {
      font-weight: 600;
      font-size: 1.25rem;
    }

    .modal-header .btn-close {
      filter: brightness(0) invert(1);
      opacity: 0.8;
    }

    .modal-header .btn-close:hover {
      opacity: 1;
    }

    .modal-body {
      padding: 2rem;
      background: #ffffff;
    }

    /* Enhanced Form Controls */
    .form-control {
      border: 2px solid #e9ecef;
      border-radius: 10px;
      padding: 0.75rem 1rem;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }

    .form-control:focus {
      border-color: #71c55d;
      box-shadow: 0 0 0 0.2rem rgba(113, 197, 93, 0.25);
    }

    .form-label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 0.5rem;
    }

    /* Enhanced Buttons */
    .btn {
      border-radius: 10px;
      font-weight: 600;
      padding: 0.65rem 1.5rem;
      transition: all 0.3s ease;
      border: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #71c55d 0%, #5ba649 100%);
      border: none;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #5ba649 0%, #4a9639 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(113, 197, 93, 0.3);
    }

    /* Enhanced Section Cards */
    .section-card {
      border: none;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      overflow: hidden;
      background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
      position: relative;
    }

    .section-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .section-card.active-card {
      border-left: 5px solid #71c55d;
    }

    .section-card.archived-card {
      border-left: 5px solid #6c757d;
      opacity: 0.8;
    }

    .section-card .card-header {
      background: linear-gradient(135deg, #71c55d 0%, #5ba649 100%);
      color: white;
      border: none;
      padding: 1.5rem 2rem;
      position: relative;
    }

    .section-card.archived-card .card-header {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    }

    .section-card .card-body {
      padding: 2rem;
      position: relative;
    }

    .section-card .card-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .section-stats {
      display: flex;
      gap: 2rem;
      margin: 1.5rem 0;
      padding: 1rem;
      background: rgba(113, 197, 93, 0.1);
      border-radius: 12px;
      border-left: 4px solid #71c55d;
    }

    .section-card.archived-card .section-stats {
      background: rgba(108, 117, 125, 0.1);
      border-left-color: #6c757d;
    }

    .stat-item {
      text-align: center;
      flex: 1;
    }

    .stat-number {
      font-size: 1.75rem;
      font-weight: bold;
      color: #71c55d;
      display: block;
    }

    .section-card.archived-card .stat-number {
      color: #6c757d;
    }

    .stat-label {
      font-size: 0.85rem;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .section-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: space-between;
      margin-top: 1.5rem;
    }

    .btn-enter {
      background: linear-gradient(135deg, #71c55d 0%, #5ba649 100%);
      color: white;
      flex: 1;
      padding: 0.875rem 1.5rem;
      font-weight: 600;
      border-radius: 12px;
      text-decoration: none;
      text-align: center;
      transition: all 0.3s ease;
    }

    .btn-enter:hover {
      background: linear-gradient(135deg, #5ba649 0%, #4a9639 100%);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(113, 197, 93, 0.3);
    }

    .section-actions-header {
      align-items: center;
    }

    .section-actions-header .btn {
      border: none;
      border-radius: 8px;
      padding: 0.375rem 0.75rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .section-actions-header .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .section-actions-header .btn-warning {
      background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
      color: #212529;
    }

    .section-actions-header .btn-warning:hover {
      background: linear-gradient(135deg, #e0a800 0%, #d39e00 100%);
      color: #212529;
    }

    .section-actions-header .btn-danger {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      color: white;
    }

    .section-actions-header .btn-danger:hover {
      background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
      color: white;
    }

    .section-actions-header .btn-success {
      background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
      color: white;
    }

    .section-actions-header .btn-success:hover {
      background: linear-gradient(135deg, #1e7e34 0%, #1c7430 100%);
      color: white;
    }

    /* Section Headers */
    .section-header {
      margin: 3rem 0 2rem 0;
      text-align: left;
    }

    .section-header h4 {
      font-weight: 700;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.5rem;
    }

    .section-header.archived h4 {
      color: #6c757d;
    }

    .section-header i {
      font-size: 1.25rem;
    }

    /* Badge Enhancements */
    .badge {
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      background: white;
      border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .empty-state i {
      font-size: 4rem;
      color: #dee2e6;
      margin-bottom: 1.5rem;
    }

    .empty-state h5 {
      color: #6c757d;
      margin-bottom: 1rem;
    }

    .empty-state p {
      color: #adb5bd;
      font-size: 1.1rem;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .section-title {
        flex-direction: column;
        text-align: center;
      }
      
      .section-title h2 {
        font-size: 2rem;
      }
      
      .section-stats {
        flex-direction: column;
        gap: 1rem;
      }
      
      .section-actions {
        flex-direction: column;
        gap: 1rem;
      }
    }
  </style>
</head>

<body>

  <header id="header" class="header d-flex align-items-center sticky-top">
    <div class="container-fluid container-xl position-relative d-flex align-items-center justify-content-between">

        <!-- <img src="../assets/img/logo.png" alt=""> -->
        <a href="" class="logo d-flex align-items-center">
        <h1 class="sitename"><span></span>FLED</h1>
      </a>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="#" id="logout">Logout</a></li>
        </ul>
        <!-- Mobile nav toggler (required for responsive menu) -->
        <i class="mobile-nav-toggle d-xl-none bi bi-list" aria-label="Toggle navigation"></i>
      </nav>

    </div>
  </header>

  <main class="main">

    <section class="dashboard section">
      <div class="container">
        <div class="section-title">
          <h2>Teacher Dashboard</h2>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSectionModal">
            <i class="bi bi-plus-circle"></i> Add New Section
          </button>
        </div>
        <div class="row" id="sectionsContainer">
          <!-- Sections will be loaded here -->
        </div>
      </div>
    </section>

    <!-- Add Section Modal -->
    <div class="modal fade" id="addSectionModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-plus-circle me-2"></i>Add New Section
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="addSectionForm">
              <div class="mb-3">
                <label for="sectionName" class="form-label">
                  <i class="bi bi-card-text me-2"></i>Section Name
                </label>
                <input type="text" class="form-control" id="sectionName" placeholder="e.g., Science 101, Math Advanced" required>
                <div class="form-text">Choose a descriptive name for your section</div>
              </div>
              <div class="mb-3">
                <label for="grade" class="form-label">
                  <i class="bi bi-mortarboard me-2"></i>Grade Level
                </label>
                <select class="form-control" id="grade" required>
                  <option value="">Select Grade Level</option>
                  <option value="Kindergarten">Kindergarten</option>
                  <option value="1st Grade">1st Grade</option>
                  <option value="2nd Grade">2nd Grade</option>
                  <option value="3rd Grade">3rd Grade</option>
                  <option value="4th Grade">4th Grade</option>
                  <option value="5th Grade">5th Grade</option>
                  <option value="6th Grade">6th Grade</option>
                  <option value="7th Grade">7th Grade</option>
                  <option value="8th Grade">8th Grade</option>
                  <option value="9th Grade">9th Grade</option>
                  <option value="10th Grade">10th Grade</option>
                  <option value="11th Grade">11th Grade</option>
                  <option value="12th Grade">12th Grade</option>
                </select>
                <div class="form-text">Select the appropriate grade level for this section</div>
              </div>
              <div class="d-grid">
                <button type="submit" class="btn btn-primary btn-lg">
                  <i class="bi bi-plus-circle me-2"></i>Create Section
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- Vendor JS Files -->
  <script src="../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/vendor/aos/aos.js"></script>

  <!-- Firebase SDK + UI helpers -->
  <script type="module">
    import { auth, db } from "./js/firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { collection, query, where, getDocs, addDoc, serverTimestamp, doc, getDoc, deleteDoc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
  import { showLoading, hideLoading, showAlert, consumeFlash, confirmModal } from "./js/ui.js";
    import { registerMessaging } from "./js/fcm.js";
    
    // Security: Immediate authentication check
    let authCheckTimeout;
    let isAuthenticated = false;
    let authCheckComplete = false;
    
    // Block the page initially until auth is verified
    document.body.style.display = 'none';
    
    // Timeout for auth check - if no response in 5 seconds, redirect to login
    authCheckTimeout = setTimeout(() => {
      if (!authCheckComplete) {
        console.log('Auth check timeout - redirecting to login');
        window.location.replace('login.html');
      }
    }, 5000);

    // Helper functions for section statistics
    function getActiveStatus() {
      return 'Active';
    }
    

    
    function getTotalMessages(sectionId) {
      // This would ideally fetch from database, but for now return placeholder
      return Math.floor(Math.random() * 5);
    }



    async function loadSections(teacherId) {
      const q = query(
        collection(db, 'sections'),
        where('teacherId', '==', teacherId),
        where('ownerUid', '==', teacherId)
      );
      const querySnapshot = await getDocs(q);
      const container = document.getElementById('sectionsContainer');
      container.innerHTML = '';
      
      const activeSections = [];
      const archivedSections = [];
      
      querySnapshot.forEach((docSnap) => {
        const section = { id: docSnap.id, ...docSnap.data() };
        if (section.archived) {
          archivedSections.push(section);
        } else {
          activeSections.push(section);
        }
      });
      
      // Display active sections
      if (activeSections.length > 0) {
        container.insertAdjacentHTML('beforeend', '<div class="col-12 section-header"><h4><i class="bi bi-folder-check"></i> Active Sections</h4></div>');
        activeSections.forEach((section, index) => {
          const count = Array.isArray(section.students) ? section.students.length : 0;
          const createdDate = section.createdAt ? new Date(section.createdAt.seconds * 1000) : new Date();
          const card = `
            <div class="col-lg-4 col-md-6 mb-4">
              <div class="card section-card active-card h-100">
                <div class="card-header">
                  <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">${section.name}</h5>
                    <div class="section-actions-header d-flex gap-2">
                      <button type="button" class="btn btn-sm btn-warning" onclick="archiveSection('${section.id}', '${section.name}')" title="Archive Section">
                        <i class="bi bi-archive"></i>
                      </button>
                      <button type="button" class="btn btn-sm btn-danger" onclick="deleteSection('${section.id}', '${section.name}')" title="Delete Forever">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <span class="badge bg-primary fs-6">Grade ${section.grade}</span>
                    <span class="badge bg-success ms-2">${getActiveStatus()}</span>
                  </div>
                  
                  <div class="section-stats">
                    <div class="stat-item">
                      <span class="stat-number">${count}</span>
                      <span class="stat-label">Students</span>
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <small class="text-muted">
                      <i class="bi bi-calendar3 me-1"></i>
                      Created ${createdDate.toLocaleDateString()}
                    </small>
                  </div>
                  
                  <div class="section-actions">
                    <a href="section.html?sectionId=${section.id}" class="btn-enter">
                      <i class="bi bi-box-arrow-in-right me-2"></i>Enter Section
                    </a>
                  </div>
                </div>
              </div>
            </div>`;
          container.insertAdjacentHTML('beforeend', card);
        });
      }
      
      // Display archived sections
      if (archivedSections.length > 0) {
        container.insertAdjacentHTML('beforeend', '<div class="col-12 section-header archived mt-4"><h4><i class="bi bi-archive"></i> Archived Sections</h4></div>');
        archivedSections.forEach((section) => {
          const count = Array.isArray(section.students) ? section.students.length : 0;
          const archivedDate = section.archivedAt ? new Date(section.archivedAt.seconds * 1000) : new Date();
          const createdDate = section.createdAt ? new Date(section.createdAt.seconds * 1000) : new Date();
          const card = `
            <div class="col-lg-4 col-md-6 mb-4">
              <div class="card section-card archived-card h-100">
                <div class="card-header">
                  <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                      ${section.name}
                      <span class="badge bg-light text-dark ms-2">Archived</span>
                    </h5>
                    <div class="section-actions-header d-flex gap-2">
                      <button type="button" class="btn btn-sm btn-success" onclick="restoreSection('${section.id}', '${section.name}')" title="Restore Section">
                        <i class="bi bi-arrow-clockwise"></i>
                      </button>
                      <button type="button" class="btn btn-sm btn-danger" onclick="deleteSection('${section.id}', '${section.name}')" title="Delete Forever">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <span class="badge bg-secondary fs-6">Grade ${section.grade}</span>
                    <span class="badge bg-warning ms-2">Archived</span>
                  </div>
                  
                  <div class="section-stats">
                    <div class="stat-item">
                      <span class="stat-number">${count}</span>
                      <span class="stat-label">Students</span>
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <div class="d-flex justify-content-between">
                      <small class="text-muted">
                        <i class="bi bi-calendar3 me-1"></i>
                        Created ${createdDate.toLocaleDateString()}
                      </small>
                      <small class="text-muted">
                        <i class="bi bi-archive me-1"></i>
                        Archived ${archivedDate.toLocaleDateString()}
                      </small>
                    </div>
                  </div>
                  
                  <div class="section-actions">
                    <button type="button" class="btn-enter" onclick="restoreSection('${section.id}', '${section.name}')" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);">
                      <i class="bi bi-arrow-clockwise me-2"></i>Restore Section
                    </button>
                  </div>
                </div>
              </div>
            </div>`;
          container.insertAdjacentHTML('beforeend', card);
        });
      }
      
      if (activeSections.length === 0 && archivedSections.length === 0) {
        container.innerHTML = `
          <div class="col-12">
            <div class="empty-state">
              <i class="bi bi-folder-x"></i>
              <h5>No Sections Yet</h5>
              <p>Create your first section to start managing students, tasks, and attendance.</p>
              <button class="btn btn-primary btn-lg mt-3" data-bs-toggle="modal" data-bs-target="#addSectionModal">
                <i class="bi bi-plus-circle me-2"></i>Create Your First Section
              </button>
            </div>
          </div>`;
      }
    }



    // Make functions globally available for onclick handlers
    window.archiveSection = archiveSection;
    window.restoreSection = restoreSection;
    window.deleteSection = deleteSection;

    // Archive section function
    async function archiveSection(sectionId, sectionName) {
      try {
        const confirmed = await confirmModal(
          'Archive Section', 
          `Are you sure you want to archive "${sectionName}"? This will hide the section but keep all data intact. You can restore it later.`,
          { confirmText: 'Archive', cancelText: 'Cancel', variant: 'warning' }
        );
        
        if (!confirmed) return;
        
        showLoading('Archiving section...');
        
        await updateDoc(doc(db, 'sections', sectionId), {
          archived: true,
          archivedAt: serverTimestamp()
        });
        
        await loadSections(auth.currentUser.uid);
        showAlert(`Section "${sectionName}" has been archived successfully.`, 'success');
      } catch (err) {
        console.error('Error archiving section:', err);
        showAlert(`Error archiving section: ${err.message}`, 'danger');
      } finally {
        hideLoading();
      }
    }
    
    // Restore section function
    async function restoreSection(sectionId, sectionName) {
      try {
        const confirmed = await confirmModal(
          'Restore Section', 
          `Are you sure you want to restore "${sectionName}"? This will make the section active again.`,
          { confirmText: 'Restore', cancelText: 'Cancel', variant: 'success' }
        );
        
        if (!confirmed) return;
        
        showLoading('Restoring section...');
        
        await updateDoc(doc(db, 'sections', sectionId), {
          archived: false,
          archivedAt: null,
          restoredAt: serverTimestamp()
        });
        
        await loadSections(auth.currentUser.uid);
        showAlert(`Section "${sectionName}" has been restored successfully.`, 'success');
      } catch (err) {
        console.error('Error restoring section:', err);
        showAlert(`Error restoring section: ${err.message}`, 'danger');
      } finally {
        hideLoading();
      }
    }
    
    // Delete section and all related data
    async function deleteSection(sectionId, sectionName) {
      try {
        console.log('Delete function called for:', sectionId, sectionName);
        
        const confirmed = await confirmModal(
          'Delete Section Forever', 
          `Are you sure you want to permanently delete "${sectionName}" and ALL its data?\n\nThis will delete:\n• All students\n• All attendance records\n• All tasks\n• All messages\n\nThis action CANNOT be undone!`,
          { confirmText: 'Delete Forever', cancelText: 'Cancel', variant: 'danger' }
        );
        
        if (!confirmed) {
          console.log('User cancelled deletion');
          return;
        }
        
        // Double confirmation for permanent deletion
        const doubleConfirmed = await confirmModal(
          'FINAL WARNING!', 
          `You are about to permanently delete "${sectionName}" and ALL its data.\n\nThis is your final chance to cancel. Are you absolutely sure?`,
          { confirmText: 'Yes, Delete Everything', cancelText: 'Cancel', variant: 'danger' }
        );
        
        if (!doubleConfirmed) {
          console.log('User cancelled double confirmation');
          return;
        }
        
        showLoading('Deleting section and all related data...');
        console.log('Starting deletion process for section:', sectionId);
        
        const userId = auth.currentUser.uid;
        let deletedCounts = { students: 0, attendance: 0, sessions: 0, tasks: 0, messages: 0, parents: 0 };
        
        try {
          // Delete students first
          console.log('Deleting students...');
          const studentsQuery = query(
            collection(db, 'students'),
            where('sectionId', '==', sectionId),
            where('ownerUid', '==', userId)
          );
          const studentsSnapshot = await getDocs(studentsQuery);
          console.log('Found', studentsSnapshot.size, 'students to delete');
          
          for (const studentDoc of studentsSnapshot.docs) {
            await deleteDoc(studentDoc.ref);
            deletedCounts.students++;
          }
          
          // Delete attendance records
          console.log('Deleting attendance records...');
          const attendanceQuery = query(
            collection(db, 'attendance'),
            where('sectionId', '==', sectionId),
            where('ownerUid', '==', userId)
          );
          const attendanceSnapshot = await getDocs(attendanceQuery);
          console.log('Found', attendanceSnapshot.size, 'attendance records to delete');
          
          for (const attendanceDoc of attendanceSnapshot.docs) {
            await deleteDoc(attendanceDoc.ref);
            deletedCounts.attendance++;
          }
          
          // Delete attendance sessions
          console.log('Deleting attendance sessions...');
          const sessionsQuery = query(
            collection(db, 'attendanceSessions'),
            where('sectionId', '==', sectionId),
            where('ownerUid', '==', userId)
          );
          const sessionsSnapshot = await getDocs(sessionsQuery);
          console.log('Found', sessionsSnapshot.size, 'attendance sessions to delete');
          
          for (const sessionDoc of sessionsSnapshot.docs) {
            await deleteDoc(sessionDoc.ref);
            deletedCounts.sessions++;
          }
          
          // Delete tasks
          console.log('Deleting tasks...');
          const tasksQuery = query(
            collection(db, 'tasks'),
            where('sectionId', '==', sectionId),
            where('ownerUid', '==', userId)
          );
          const tasksSnapshot = await getDocs(tasksQuery);
          console.log('Found', tasksSnapshot.size, 'tasks to delete');
          
          for (const taskDoc of tasksSnapshot.docs) {
            await deleteDoc(taskDoc.ref);
            deletedCounts.tasks++;
          }
          
          // Delete messages
          console.log('Deleting messages...');
          const messagesQuery = query(
            collection(db, 'messages'),
            where('sectionId', '==', sectionId),
            where('ownerUid', '==', userId)
          );
          const messagesSnapshot = await getDocs(messagesQuery);
          console.log('Found', messagesSnapshot.size, 'messages to delete');
          
          for (const messageDoc of messagesSnapshot.docs) {
            await deleteDoc(messageDoc.ref);
            deletedCounts.messages++;
          }
          
          // Finally, delete the section itself
          console.log('Deleting section...');
          await deleteDoc(doc(db, 'sections', sectionId));
          
          console.log('All deletions completed successfully');
          await loadSections(userId);
          
          showAlert(
            `Section "${sectionName}" and all related data has been permanently deleted:\\n\\n` +
            `• ${deletedCounts.students} students\\n` +
            `• ${deletedCounts.attendance} attendance records\\n` +
            `• ${deletedCounts.sessions} attendance sessions\\n` +
            `• ${deletedCounts.tasks} tasks\\n` +
            `• ${deletedCounts.messages} messages`,
            'success'
          );
        } catch (deleteError) {
          console.error('Error during deletion process:', deleteError);
          throw deleteError;
        }
      } catch (err) {
        console.error('Error deleting section:', err);
        showAlert(`Error deleting section: ${err.message}`, 'danger');
      } finally {
        hideLoading();
      }
    }

    document.getElementById('addSectionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = e.submitter || e.target.querySelector('button[type="submit"]');
      if (btn) btn.disabled = true;
      try {
        const name = document.getElementById('sectionName').value.trim();
        const grade = document.getElementById('grade').value.trim();
        const user = auth.currentUser;
        await addDoc(collection(db, 'sections'), {
          name,
          grade,
          teacherId: user.uid,
          students: [],
          ownerUid: user.uid,
          createdAt: serverTimestamp()
        });
        document.getElementById('addSectionModal').querySelector('.btn-close').click();
        await loadSections(user.uid);
        showAlert('Section added.', 'success');
        e.target.reset();
      } catch (err) {
        showAlert(err.message, 'danger');
      } finally {
        if (btn) btn.disabled = false;
      }
    });

    // Additional security check for direct URL access
    function checkAuthenticationSecurity() {
      // Check if user tried to access directly without proper authentication flow
      const referrer = document.referrer;
      const currentURL = window.location.href;
      
      // If accessing directly (no referrer or not from login), be extra cautious
      if (!referrer || !referrer.includes('login.html')) {
        console.log('Direct access detected - requiring fresh authentication');
      }
    }
    
    checkAuthenticationSecurity();
    consumeFlash();
    showLoading('Checking session…');
    
    onAuthStateChanged(auth, async (user) => {
      try {
        // Clear the timeout since we got an auth response
        if (authCheckTimeout) {
          clearTimeout(authCheckTimeout);
          authCheckComplete = true;
        }
        
        console.log('Auth state changed. User:', user ? user.uid : 'null');
        
        if (!user) {
          console.log('No authenticated user - redirecting to login');
          hideLoading();
          // Clear any existing sessions
          localStorage.clear();
          sessionStorage.clear();
          window.location.replace('login.html');
          return;
        }
        
        // Verify user exists and has proper role
        console.log('Verifying user role and permissions...');
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        
        if (!userDoc.exists()) {
          console.log('User document not found - redirecting to login');
          await signOut(auth);
          localStorage.clear();
          sessionStorage.clear();
          hideLoading();
          window.location.replace('login.html');
          return;
        }
        
        const userData = userDoc.data();
        if (userData.role !== 'teacher') {
          console.log('User is not a teacher - redirecting to login');
          await signOut(auth);
          localStorage.clear();
          sessionStorage.clear();
          hideLoading();
          window.location.replace('login.html');
          return;
        }
        
        // Check if account is active/enabled
        if (userData.disabled === true) {
          console.log('User account is disabled');
          await signOut(auth);
          localStorage.clear();
          sessionStorage.clear();
          hideLoading();
          showAlert('Your account has been disabled. Please contact support.', 'danger');
          setTimeout(() => window.location.replace('login.html'), 3000);
          return;
        }
        
        // All checks passed - user is authenticated and authorized
        console.log('User authenticated successfully:', userData.email);
        isAuthenticated = true;
        
        // Show the page content
        document.body.style.display = 'block';
        
        // Register FCM for push notifications (non-blocking)
        registerMessaging(user).catch(err => {
          console.warn('FCM registration failed (non-blocking):', err);
        });
        
        hideLoading();
        await loadSections(user.uid);
        
      } catch (err) {
        console.error('Authentication error:', err);
        hideLoading();
        
        // On any authentication error, sign out and redirect
        try {
          await signOut(auth);
        } catch (signOutErr) {
          console.error('Error signing out:', signOutErr);
        }
        
        localStorage.clear();
        sessionStorage.clear();
        showAlert('Authentication failed. Please log in again.', 'danger');
        setTimeout(() => window.location.replace('login.html'), 2000);
      }
    });

    // Enhanced logout with proper cleanup
    document.getElementById('logout')?.addEventListener('click', async (e) => {
      e.preventDefault();
      const ok = await confirmModal('Sign out', 'Are you sure you want to log out?', { confirmText: 'Log out', cancelText: 'Stay', variant: 'danger' });
      if (!ok) return;
      
      showLoading('Signing out…');
      
      try {
        // Clear all local data
        localStorage.clear();
        sessionStorage.clear();
        
        // Sign out from Firebase
        await signOut(auth);
        
        // Force redirect
        window.location.replace('login.html');
      } catch (err) {
        console.error('Logout error:', err);
        // Force redirect even if sign out fails
        window.location.replace('login.html');
      }
    });
    
    // Security: Monitor for authentication state changes
    // If user gets signed out elsewhere, redirect immediately
    auth.onIdTokenChanged((user) => {
      if (isAuthenticated && !user) {
        console.log('User signed out elsewhere - redirecting');
        localStorage.clear();
        sessionStorage.clear();
        window.location.replace('login.html');
      }
    });
    
    // Security: Page visibility change handler
    // Check authentication when page becomes visible again
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && isAuthenticated) {
        // Page became visible, verify user is still authenticated
        const user = auth.currentUser;
        if (!user) {
          console.log('User no longer authenticated - redirecting');
          localStorage.clear();
          sessionStorage.clear();
          window.location.replace('login.html');
        }
      }
    });
  </script>
  <footer id="footer" class="footer light-background">

    <div class="container">
      <div class="copyright text-center ">
        <p>© <span>Copyright</span> <strong class="px-1 sitename">FLED</strong> <span>All Rights Reserved</span></p>
      </div>
      <div class="social-links d-flex justify-content-center">
        <a href=""><i class="bi bi-twitter-x"></i></a>
        <a href=""><i class="bi bi-facebook"></i></a>
        <a href=""><i class="bi bi-instagram"></i></a>
        <a href=""><i class="bi bi-linkedin"></i></a>
      </div>
      <div class="credits">
        Designed by <a href="https://bootstrapmade.com/">BootstrapMade</a>
      </div>
    </div>

  </footer>

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Preloader -->
  <div id="preloader"></div>

  <!-- Vendor JS Files -->
  <script src="../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script>
    (function ensureBootstrap(){
      if (!(window.bootstrap && window.bootstrap.Modal)) {
        var s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js';
        s.integrity = 'sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz';
        s.crossOrigin = 'anonymous';
        s.onload = function(){ console.log('Bootstrap fallback loaded'); };
        document.head.appendChild(s);
      }
    })();
  </script>
  <script src="../assets/vendor/php-email-form/validate.js"></script>
  <script src="../assets/vendor/aos/aos.js"></script>
  <script src="../assets/vendor/glightbox/js/glightbox.min.js"></script>

  <!-- Main JS File -->
  <script src="../assets/js/main.js"></script>

  <!-- Custom script to hide preloader -->
  <script>
    window.addEventListener('load', function() {
      const preloader = document.getElementById('preloader');
      if (preloader) {
        preloader.style.display = 'none';
      }
    });
  </script>

</body>

</html>