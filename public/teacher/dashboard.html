<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>FLED - Teacher Dashboard</title>

  <!-- Favicons -->
  <link href="../assets/img/favicon.png" rel="icon">
  <link href="../assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="../assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="../assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="../assets/vendor/aos/aos.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="../assets/css/main.css" rel="stylesheet">
</head>

<body>

  <header id="header" class="header d-flex align-items-center sticky-top">
    <div class="container-fluid container-xl position-relative d-flex align-items-center justify-content-between">

        <!-- <img src="../assets/img/logo.png" alt=""> -->
        <a href="" class="logo d-flex align-items-center">
        <h1 class="sitename"><span></span>FLED</h1>
      </a>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="#" id="logout">Logout</a></li>
        </ul>
        <!-- Mobile nav toggler (required for responsive menu) -->
        <i class="mobile-nav-toggle d-xl-none bi bi-list" aria-label="Toggle navigation"></i>
      </nav>

    </div>
  </header>

  <main class="main">

    <section class="dashboard section">
      <div class="container">
        <div class="section-title">
          <h2>Teacher Dashboard</h2>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSectionModal">
            <i class="bi bi-plus-circle"></i> Add New Section
          </button>
        </div>
        <div class="row" id="sectionsContainer">
          <!-- Sections will be loaded here -->
        </div>
      </div>
    </section>

    <!-- Add Section Modal -->
    <div class="modal fade" id="addSectionModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add New Section</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="addSectionForm">
              <div class="mb-3">
                <label for="sectionName" class="form-label">Section Name</label>
                <input type="text" class="form-control" id="sectionName" required>
              </div>
              <div class="mb-3">
                <label for="grade" class="form-label">Grade Level</label>
                <input type="text" class="form-control" id="grade" required>
              </div>
              <button type="submit" class="btn btn-primary">Add Section</button>
            </form>
          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- Vendor JS Files -->
  <script src="../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/vendor/aos/aos.js"></script>

  <!-- Firebase SDK + UI helpers -->
  <script type="module">
    import { auth, db } from "./js/firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { collection, query, where, getDocs, addDoc, serverTimestamp, doc, getDoc, deleteDoc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
  import { showLoading, hideLoading, showAlert, consumeFlash, confirmModal } from "./js/ui.js";
    import { registerMessaging } from "./js/fcm.js";

    async function loadSections(teacherId) {
      const q = query(
        collection(db, 'sections'),
        where('teacherId', '==', teacherId),
        where('ownerUid', '==', teacherId)
      );
      const querySnapshot = await getDocs(q);
      const container = document.getElementById('sectionsContainer');
      container.innerHTML = '';
      
      const activeSections = [];
      const archivedSections = [];
      
      querySnapshot.forEach((docSnap) => {
        const section = { id: docSnap.id, ...docSnap.data() };
        if (section.archived) {
          archivedSections.push(section);
        } else {
          activeSections.push(section);
        }
      });
      
      // Display active sections
      if (activeSections.length > 0) {
        container.insertAdjacentHTML('beforeend', '<div class="col-12"><h4 class="text-primary mb-3"><i class="bi bi-folder"></i> Active Sections</h4></div>');
        activeSections.forEach((section) => {
          const count = Array.isArray(section.students) ? section.students.length : 0;
          const card = `
            <div class="col-md-4 mb-3">
              <div class="card h-100 shadow-sm border-primary">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title mb-0">${section.name}</h5>
                    <div class="btn-group">
                      <button class="btn btn-outline-warning btn-sm" data-action="archive" data-section-id="${section.id}" data-section-name="${section.name}" title="Archive Section">
                        <i class="bi bi-archive"></i>
                      </button>
                      <button class="btn btn-outline-danger btn-sm" data-action="delete" data-section-id="${section.id}" data-section-name="${section.name}" title="Delete Permanently">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                  <p class="card-text">Grade: ${section.grade}</p>
                  <p class="card-text">Students: ${count}</p>
                  <div class="d-grid">
                    <a href="section.html?sectionId=${section.id}" class="btn btn-primary">
                      <i class="bi bi-box-arrow-in-right"></i> Enter Section
                    </a>
                  </div>
                </div>
              </div>
            </div>`;
          container.insertAdjacentHTML('beforeend', card);
        });
      }
      
      // Display archived sections
      if (archivedSections.length > 0) {
        container.insertAdjacentHTML('beforeend', '<div class="col-12 mt-4"><h4 class="text-muted mb-3"><i class="bi bi-archive"></i> Archived Sections</h4></div>');
        archivedSections.forEach((section) => {
          const count = Array.isArray(section.students) ? section.students.length : 0;
          const card = `
            <div class="col-md-4 mb-3">
              <div class="card h-100 shadow-sm border-secondary" style="opacity: 0.7;">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title mb-0">${section.name} <span class="badge bg-secondary">Archived</span></h5>
                    <div class="btn-group">
                      <button class="btn btn-outline-success btn-sm" data-action="restore" data-section-id="${section.id}" data-section-name="${section.name}" title="Restore Section">
                        <i class="bi bi-arrow-clockwise"></i>
                      </button>
                      <button class="btn btn-outline-danger btn-sm" data-action="delete" data-section-id="${section.id}" data-section-name="${section.name}" title="Delete Permanently">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                  <p class="card-text">Grade: ${section.grade}</p>
                  <p class="card-text">Students: ${count}</p>
                  <p class="text-muted small">Archived on: ${section.archivedAt ? new Date(section.archivedAt.seconds * 1000).toLocaleDateString() : 'Unknown'}</p>
                </div>
              </div>
            </div>`;
          container.insertAdjacentHTML('beforeend', card);
        });
      }
      
      if (activeSections.length === 0 && archivedSections.length === 0) {
        container.innerHTML = '<div class="col-12 text-center py-5"><i class="bi bi-folder-x display-1 text-muted"></i><p class="text-muted mt-3">No sections found. Create your first section to get started!</p></div>';
      }
    }



    // Add event delegation for dropdown clicks
    document.addEventListener('click', async (e) => {
      console.log('Click detected on:', e.target);
      
      if (e.target.closest('[data-action]')) {
        e.preventDefault();
        console.log('Action element found');
        
        const element = e.target.closest('[data-action]');
        const action = element.getAttribute('data-action');
        const sectionId = element.getAttribute('data-section-id');
        const sectionName = element.getAttribute('data-section-name');
        
        console.log('Action:', action, 'Section:', sectionId, sectionName);
        
        try {
          switch (action) {
            case 'archive':
              console.log('Calling archiveSection');
              await archiveSection(sectionId, sectionName);
              break;
            case 'restore':
              console.log('Calling restoreSection');
              await restoreSection(sectionId, sectionName);
              break;
            case 'delete':
              console.log('Calling deleteSection');
              await deleteSection(sectionId, sectionName);
              break;
            default:
              console.log('Unknown action:', action);
          }
        } catch (error) {
          console.error('Error in action handler:', error);
          showAlert(`Error: ${error.message}`, 'danger');
        }
      }
    });

    // Archive section function
    async function archiveSection(sectionId, sectionName) {
      try {
        const confirmed = await confirmModal(
          'Archive Section', 
          `Are you sure you want to archive "${sectionName}"? This will hide the section but keep all data intact. You can restore it later.`,
          { confirmText: 'Archive', cancelText: 'Cancel', variant: 'warning' }
        );
        
        if (!confirmed) return;
        
        showLoading('Archiving section...');
        
        await updateDoc(doc(db, 'sections', sectionId), {
          archived: true,
          archivedAt: serverTimestamp()
        });
        
        await loadSections(auth.currentUser.uid);
        showAlert(`Section "${sectionName}" has been archived successfully.`, 'success');
      } catch (err) {
        console.error('Error archiving section:', err);
        showAlert(`Error archiving section: ${err.message}`, 'danger');
      } finally {
        hideLoading();
      }
    }
    
    // Restore section function
    async function restoreSection(sectionId, sectionName) {
      try {
        const confirmed = await confirmModal(
          'Restore Section', 
          `Are you sure you want to restore "${sectionName}"? This will make the section active again.`,
          { confirmText: 'Restore', cancelText: 'Cancel', variant: 'success' }
        );
        
        if (!confirmed) return;
        
        showLoading('Restoring section...');
        
        await updateDoc(doc(db, 'sections', sectionId), {
          archived: false,
          archivedAt: null,
          restoredAt: serverTimestamp()
        });
        
        await loadSections(auth.currentUser.uid);
        showAlert(`Section "${sectionName}" has been restored successfully.`, 'success');
      } catch (err) {
        console.error('Error restoring section:', err);
        showAlert(`Error restoring section: ${err.message}`, 'danger');
      } finally {
        hideLoading();
      }
    }
    
    // Delete section and all related data
    async function deleteSection(sectionId, sectionName) {
      try {
        console.log('Delete function called for:', sectionId, sectionName);
        
        const confirmed = confirm(`Are you sure you want to permanently delete "${sectionName}" and ALL its data?\n\nThis will delete:\n• All students\n• All attendance records\n• All tasks\n• All messages\n\nThis action CANNOT be undone!`);
        
        if (!confirmed) {
          console.log('User cancelled deletion');
          return;
        }
        
        // Double confirmation using native confirm for now
        const doubleConfirmed = confirm(`FINAL WARNING!\n\nYou are about to permanently delete "${sectionName}" and ALL its data.\n\nType OK to confirm this permanent deletion.`);
        
        if (!doubleConfirmed) {
          console.log('User cancelled double confirmation');
          return;
        }
        
        showLoading('Deleting section and all related data...');
        console.log('Starting deletion process for section:', sectionId);
        
        const userId = auth.currentUser.uid;
        let deletedCounts = { students: 0, attendance: 0, sessions: 0, tasks: 0, messages: 0, parents: 0 };
        
        try {
          // Delete students first
          console.log('Deleting students...');
          const studentsQuery = query(
            collection(db, 'students'),
            where('sectionId', '==', sectionId),
            where('ownerUid', '==', userId)
          );
          const studentsSnapshot = await getDocs(studentsQuery);
          console.log('Found', studentsSnapshot.size, 'students to delete');
          
          for (const studentDoc of studentsSnapshot.docs) {
            await deleteDoc(studentDoc.ref);
            deletedCounts.students++;
          }
          
          // Delete attendance records
          console.log('Deleting attendance records...');
          const attendanceQuery = query(
            collection(db, 'attendance'),
            where('sectionId', '==', sectionId),
            where('ownerUid', '==', userId)
          );
          const attendanceSnapshot = await getDocs(attendanceQuery);
          console.log('Found', attendanceSnapshot.size, 'attendance records to delete');
          
          for (const attendanceDoc of attendanceSnapshot.docs) {
            await deleteDoc(attendanceDoc.ref);
            deletedCounts.attendance++;
          }
          
          // Delete attendance sessions
          console.log('Deleting attendance sessions...');
          const sessionsQuery = query(
            collection(db, 'attendanceSessions'),
            where('sectionId', '==', sectionId),
            where('ownerUid', '==', userId)
          );
          const sessionsSnapshot = await getDocs(sessionsQuery);
          console.log('Found', sessionsSnapshot.size, 'attendance sessions to delete');
          
          for (const sessionDoc of sessionsSnapshot.docs) {
            await deleteDoc(sessionDoc.ref);
            deletedCounts.sessions++;
          }
          
          // Delete tasks
          console.log('Deleting tasks...');
          const tasksQuery = query(
            collection(db, 'tasks'),
            where('sectionId', '==', sectionId),
            where('ownerUid', '==', userId)
          );
          const tasksSnapshot = await getDocs(tasksQuery);
          console.log('Found', tasksSnapshot.size, 'tasks to delete');
          
          for (const taskDoc of tasksSnapshot.docs) {
            await deleteDoc(taskDoc.ref);
            deletedCounts.tasks++;
          }
          
          // Delete messages
          console.log('Deleting messages...');
          const messagesQuery = query(
            collection(db, 'messages'),
            where('sectionId', '==', sectionId),
            where('ownerUid', '==', userId)
          );
          const messagesSnapshot = await getDocs(messagesQuery);
          console.log('Found', messagesSnapshot.size, 'messages to delete');
          
          for (const messageDoc of messagesSnapshot.docs) {
            await deleteDoc(messageDoc.ref);
            deletedCounts.messages++;
          }
          
          // Finally, delete the section itself
          console.log('Deleting section...');
          await deleteDoc(doc(db, 'sections', sectionId));
          
          console.log('All deletions completed successfully');
          await loadSections(userId);
          
          showAlert(
            `Section "${sectionName}" and all related data has been permanently deleted:\\n\\n` +
            `• ${deletedCounts.students} students\\n` +
            `• ${deletedCounts.attendance} attendance records\\n` +
            `• ${deletedCounts.sessions} attendance sessions\\n` +
            `• ${deletedCounts.tasks} tasks\\n` +
            `• ${deletedCounts.messages} messages`,
            'success'
          );
        } catch (deleteError) {
          console.error('Error during deletion process:', deleteError);
          throw deleteError;
        }
      } catch (err) {
        console.error('Error deleting section:', err);
        showAlert(`Error deleting section: ${err.message}`, 'danger');
      } finally {
        hideLoading();
      }
    }

    document.getElementById('addSectionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = e.submitter || e.target.querySelector('button[type="submit"]');
      if (btn) btn.disabled = true;
      try {
        const name = document.getElementById('sectionName').value.trim();
        const grade = document.getElementById('grade').value.trim();
        const user = auth.currentUser;
        await addDoc(collection(db, 'sections'), {
          name,
          grade,
          teacherId: user.uid,
          students: [],
          ownerUid: user.uid,
          createdAt: serverTimestamp()
        });
        document.getElementById('addSectionModal').querySelector('.btn-close').click();
        await loadSections(user.uid);
        showAlert('Section added.', 'success');
        e.target.reset();
      } catch (err) {
        showAlert(err.message, 'danger');
      } finally {
        if (btn) btn.disabled = false;
      }
    });

  consumeFlash();
  showLoading('Checking session…');
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.replace('login.html');
        return;
      }
      try {
        // Role guard
        const u = await getDoc(doc(db, 'users', user.uid));
        if (!u.exists() || u.data().role !== 'teacher') {
          await signOut(auth);
          window.location.replace('login.html');
          return;
        }
        // Register FCM for push notifications (non-blocking)
        registerMessaging(user).catch(err => {
          console.warn('FCM registration failed (non-blocking):', err);
        });
        hideLoading();
        await loadSections(user.uid);
      } catch (err) {
        hideLoading();
        showAlert(err.message, 'danger');
      }
    });

    document.getElementById('logout')?.addEventListener('click', async (e) => {
      e.preventDefault();
      const ok = await confirmModal('Sign out', 'Are you sure you want to log out?', { confirmText: 'Log out', cancelText: 'Stay', variant: 'danger' });
      if (!ok) return;
      showLoading('Signing out…');
      await signOut(auth);
      window.location.replace('login.html');
    });
  </script>
  <footer id="footer" class="footer light-background">

    <div class="container">
      <div class="copyright text-center ">
        <p>© <span>Copyright</span> <strong class="px-1 sitename">FLED</strong> <span>All Rights Reserved</span></p>
      </div>
      <div class="social-links d-flex justify-content-center">
        <a href=""><i class="bi bi-twitter-x"></i></a>
        <a href=""><i class="bi bi-facebook"></i></a>
        <a href=""><i class="bi bi-instagram"></i></a>
        <a href=""><i class="bi bi-linkedin"></i></a>
      </div>
      <div class="credits">
        Designed by <a href="https://bootstrapmade.com/">BootstrapMade</a>
      </div>
    </div>

  </footer>

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Preloader -->
  <div id="preloader"></div>

  <!-- Vendor JS Files -->
  <script src="../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script>
    (function ensureBootstrap(){
      if (!(window.bootstrap && window.bootstrap.Modal)) {
        var s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js';
        s.integrity = 'sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz';
        s.crossOrigin = 'anonymous';
        s.onload = function(){ console.log('Bootstrap fallback loaded'); };
        document.head.appendChild(s);
      }
    })();
  </script>
  <script src="../assets/vendor/php-email-form/validate.js"></script>
  <script src="../assets/vendor/aos/aos.js"></script>
  <script src="../assets/vendor/glightbox/js/glightbox.min.js"></script>

  <!-- Main JS File -->
  <script src="../assets/js/main.js"></script>

  <!-- Custom script to hide preloader -->
  <script>
    window.addEventListener('load', function() {
      const preloader = document.getElementById('preloader');
      if (preloader) {
        preloader.style.display = 'none';
      }
    });
  </script>

</body>

</html>