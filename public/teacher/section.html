<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>FLED - Section Hub</title>

  <!-- Favicons -->
  <link href="../assets/img/favicon.svg" rel="icon" type="image/svg+xml">
  <link href="../assets/img/favicon.png" rel="alternate icon">
  <link href="../assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="../assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="../assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="../assets/vendor/aos/aos.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="../assets/css/main.css" rel="stylesheet">

  <!-- SheetJS library for Excel export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <style>
    .section-header {
      background: linear-gradient(135deg, #71c55d 0%, #5ba649 100%);
      color: white;
      padding: 2rem 0;
      margin-bottom: 0;
    }
    
    .section-nav {
      background: #f8f9fa;
      border-top: 1px solid #dee2e6;
      padding: 0;
      margin: 0;
    }
    
    .nav-tabs {
      border-bottom: none;
      background: #f8f9fa;
    }
    
    .nav-tabs .nav-link {
      border: none;
      border-radius: 0;
      padding: 1rem 2rem;
      font-weight: 600;
      color: #6c757d;
      background: transparent;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .nav-tabs .nav-link:hover {
      color: #495057;
      background: rgba(255,255,255,0.5);
    }
    
    .nav-tabs .nav-link.active {
      color: #71c55d;
      background: white;
      border-bottom: 3px solid #71c55d;
    }
    
    .nav-tabs .nav-link i {
      margin-right: 0.5rem;
    }
    
    .tab-content {
      background: white;
      min-height: 500px;
      padding: 0;
    }
    
    .tab-pane {
      padding: 2rem;
    }
    
    .breadcrumb-nav {
      background: rgba(255,255,255,0.1);
      padding: 0.5rem 0;
      border-radius: 8px;
    }
    
    .breadcrumb {
      margin: 0;
      background: transparent;
    }
    
    .breadcrumb-item a {
      color: rgba(255,255,255,0.8);
      text-decoration: none;
    }
    
    .breadcrumb-item a:hover {
      color: white;
    }
    
    .breadcrumb-item.active {
      color: white;
    }
    
    .section-stats {
      display: flex;
      gap: 2rem;
      margin-top: 1rem;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      display: block;
    }
    
    .stat-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    .loading-content {
      text-align: center;
      padding: 3rem;
      color: #6c757d;
    }
    
    .content-container {
      background: white;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    /* Enhanced Modal Styles */
    .modal-content {
      border: none;
      border-radius: 16px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
      background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
    }

    .modal-header {
      background: linear-gradient(135deg, #71c55d 0%, #5ba649 100%);
      color: white;
      border-radius: 16px 16px 0 0;
      padding: 1.5rem 2rem;
      border-bottom: none;
    }

    .modal-header .modal-title {
      font-weight: 600;
      font-size: 1.25rem;
    }

    .modal-header .btn-close {
      filter: brightness(0) invert(1);
      opacity: 0.8;
    }

    .modal-header .btn-close:hover {
      opacity: 1;
    }

    .modal-body {
      padding: 2rem;
      background: #ffffff;
    }

    .modal-footer {
      background: #f8f9fa;
      border-top: 1px solid #e9ecef;
      border-radius: 0 0 16px 16px;
      padding: 1.5rem 2rem;
    }

    /* Enhanced Form Controls */
    .form-control {
      border: 2px solid #e9ecef;
      border-radius: 10px;
      padding: 0.75rem 1rem;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }

    .form-control:focus {
      border-color: #71c55d;
      box-shadow: 0 0 0 0.2rem rgba(113, 197, 93, 0.25);
    }

    .form-control.is-valid {
      border-color: #28a745;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='m2.3 6.73.8-.8 2.6-2.6L4.3 2l-2 2L1 2.7l1.3 1.3z'/%3e%3c/svg%3e");
    }

    .form-control.is-invalid {
      border-color: #dc3545;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 4.6 2.4 2.4m0-2.4L5.8 7'/%3e%3c/svg%3e");
    }

    .form-label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 0.5rem;
    }

    /* Enhanced Buttons */
    .btn {
      border-radius: 10px;
      font-weight: 600;
      padding: 0.65rem 1.5rem;
      transition: all 0.3s ease;
      border: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #71c55d 0%, #5ba649 100%);
      border: none;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #5ba649 0%, #4a9639 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(113, 197, 93, 0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    }

    .btn-success:hover {
      background: linear-gradient(135deg, #1e7e34 0%, #155724 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
    }

    .btn-info {
      background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    }

    .btn-info:hover {
      background: linear-gradient(135deg, #138496 0%, #0f6674 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(23, 162, 184, 0.3);
    }

    .btn-warning {
      background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
      color: #212529;
    }

    .btn-warning:hover {
      background: linear-gradient(135deg, #e0a800 0%, #c69500 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 193, 7, 0.3);
      color: #212529;
    }

    .btn-outline-secondary {
      border: 2px solid #6c757d;
      color: #6c757d;
      background: transparent;
    }

    .btn-outline-secondary:hover {
      background: #6c757d;
      color: white;
      transform: translateY(-2px);
    }

    .btn-outline-danger {
      border: 2px solid #dc3545;
      color: #dc3545;
      background: transparent;
    }

    .btn-outline-danger:hover {
      background: #dc3545;
      color: white;
      transform: translateY(-2px);
    }

    .btn-outline-warning {
      border: 2px solid #ffc107;
      color: #856404;
      background: transparent;
    }

    .btn-outline-warning:hover {
      background: #ffc107;
      color: #212529;
      transform: translateY(-2px);
    }

    .btn-outline-info {
      border: 2px solid #17a2b8;
      color: #17a2b8;
      background: transparent;
    }

    .btn-outline-info:hover {
      background: #17a2b8;
      color: white;
      transform: translateY(-2px);
    }

    /* Card Enhancements */
    .card {
      border: none;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
    }

    .section-card {
      background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
    }

    .section-card .card-header {
      background: linear-gradient(135deg, #71c55d 0%, #5ba649 100%);
      color: white;
      border: none;
      padding: 1.5rem;
    }

    .section-card .card-footer {
      background: rgba(113, 197, 93, 0.05);
      border-top: 1px solid rgba(113, 197, 93, 0.2);
      padding: 1.25rem 1.5rem;
    }

    /* Badge Enhancements */
    .badge {
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
    }

    /* Table Enhancements */
    .table {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .table thead th {
      background: linear-gradient(135deg, #71c55d 0%, #5ba649 100%);
      color: white;
      font-weight: 600;
      border: none;
      padding: 1rem;
    }

    .table tbody tr {
      transition: all 0.3s ease;
    }

    .table tbody tr:hover {
      background-color: rgba(113, 197, 93, 0.1);
    }

    /* Rubric Item Styling */
    .rubric-item {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }

    .rubric-item:hover {
      border-color: #71c55d;
      background: rgba(113, 197, 93, 0.05);
    }

    /* Alert Enhancements */
    .alert {
      border: none;
      border-radius: 12px;
      padding: 1.25rem 1.5rem;
      margin-bottom: 1.5rem;
    }

    .alert-info {
      background: linear-gradient(135deg, rgba(23, 162, 184, 0.1) 0%, rgba(19, 132, 150, 0.1) 100%);
      color: #0c5460;
      border-left: 4px solid #17a2b8;
    }

    .alert-success {
      background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(30, 126, 52, 0.1) 100%);
      color: #155724;
      border-left: 4px solid #28a745;
    }

    .alert-danger {
      background: linear-gradient(135deg, rgba(220, 53, 69, 0.1) 0%, rgba(176, 42, 55, 0.1) 100%);
      color: #721c24;
      border-left: 4px solid #dc3545;
    }
  </style>
</head>

<body>

  <header id="header" class="header d-flex align-items-center sticky-top">
    <div class="container-fluid container-xl position-relative d-flex align-items-center justify-content-between">
      <a href="" class="logo d-flex align-items-center">
        <h1 class="sitename"><span></span>FLED</h1>
      </a>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li class="d-flex align-items-center gap-2">
            <img id="teacherPhoto" src="" alt="Profile" class="rounded-circle" style="width: 32px; height: 32px; object-fit: cover; display: none;">
            <span id="teacherName" style="font-weight: 500; color: #444;"></span>
          </li>
          <li><a href="dashboard.html">Dashboard</a></li>
          <!-- <li><a href="students.html">Students</a></li>
          <li><a href="attendance.html">Attendance</a></li>
          <li><a href="tasks.html">Tasks</a></li>
          <li><a href="messages.html">Messages</a></li> -->
          <li><a href="#" id="logout">Logout</a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list" aria-label="Toggle navigation"></i>
      </nav>
    </div>
  </header>

  <main class="main">
    <!-- Section Header -->
    <section class="section-header">
      <div class="container">
        <nav aria-label="breadcrumb" class="breadcrumb-nav mb-3">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></li>
            <li class="breadcrumb-item active" aria-current="page" id="section-breadcrumb">Section</li>
          </ol>
        </nav>
        
        <div class="row align-items-center">
          <div class="col-lg-8">
            <h1 class="mb-2" id="section-title">Loading Section...</h1>
            <p class="mb-0 opacity-75" id="section-subtitle">Please wait while we load the section information</p>
          </div>
          <div class="col-lg-4">
            <div class="section-stats" id="section-stats" style="display: none;">
              <div class="stat-item">
                <span class="stat-number" id="student-count">0</span>
                <span class="stat-label">Students</span>
              </div>
              <div class="stat-item">
                <span class="stat-number" id="task-count">0</span>
                <span class="stat-label">Tasks</span>
              </div>
              <div class="stat-item">
                <span class="stat-number" id="message-count">0</span>
                <span class="stat-label">Messages</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Navigation Tabs -->
    <div class="section-nav">
      <div class="container">
        <ul class="nav nav-tabs" id="sectionTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="students-tab" data-bs-toggle="tab" data-bs-target="#students" type="button" role="tab">
              <i class="bi bi-people-fill"></i>Students
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab">
              <i class="bi bi-calendar-check"></i>Attendance
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button" role="tab">
              <i class="bi bi-list-task"></i>Tasks
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="messages-tab" data-bs-toggle="tab" data-bs-target="#messages" type="button" role="tab">
              <i class="bi bi-envelope-fill"></i>Messages
            </button>
          </li>
        </ul>
      </div>
    </div>

    <!-- Tab Content -->
    <div class="content-container">
      <div class="tab-content" id="sectionTabContent">
        <!-- Students Tab -->
        <div class="tab-pane fade show active" id="students" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="bi bi-people-fill me-2"></i>Students</h3>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
              <i class="bi bi-person-plus"></i> Add Student
            </button>
          </div>
          <div id="students-content">
            <div class="loading-content">
              <div class="spinner-border text-primary" role="status"></div>
              <p class="mt-2">Loading students...</p>
            </div>
          </div>
        </div>

        <!-- Attendance Tab -->
        <div class="tab-pane fade" id="attendance" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="bi bi-calendar-check me-2"></i>Attendance</h3>
            <button class="btn btn-success" id="start-attendance-btn">
              <i class="bi bi-play-circle"></i> Start Attendance
            </button>
          </div>
          <div id="attendance-content">
            <div class="loading-content">
              <div class="spinner-border text-success" role="status"></div>
              <p class="mt-2">Loading attendance...</p>
            </div>
          </div>
        </div>

        <!-- Tasks Tab -->
        <div class="tab-pane fade" id="tasks" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="bi bi-list-task me-2"></i>Tasks</h3>
            <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#addTaskModal">
              <i class="bi bi-plus-circle"></i> Add Task
            </button>
          </div>
          <div id="tasks-content">
            <div class="loading-content">
              <div class="spinner-border text-info" role="status"></div>
              <p class="mt-2">Loading tasks...</p>
            </div>
          </div>
        </div>

        <!-- Messages Tab -->
        <div class="tab-pane fade" id="messages" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="bi bi-envelope-fill me-2"></i>Messages</h3>
            <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#sendMessageModal">
              <i class="bi bi-send"></i> Send Message
            </button>
          </div>
          <div id="messages-content">
            <div class="loading-content">
              <div class="spinner-border text-warning" role="status"></div>
              <p class="mt-2">Loading messages...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Student Modal -->
    <div class="modal fade" id="addStudentModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add New Student</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="addStudentForm">
              <div class="mb-3">
                <label for="studentName" class="form-label">Student Name</label>
                <input type="text" class="form-control" id="studentName" required>
                <div class="invalid-feedback" id="studentNameFeedback"></div>
              </div>
              <div class="mb-3">
                <label for="studentId" class="form-label">Student ID</label>
                <input type="text" class="form-control" id="studentId" required>
                <div class="invalid-feedback" id="studentIdFeedback"></div>
              </div>
              <div class="mb-3">
                <label for="parentPhone" class="form-label">Parent Phone</label>
                <input type="tel" class="form-control" id="parentPhone" required>
              </div>
              <div class="mb-3">
                <label for="parentEmail" class="form-label">Parent Email</label>
                <input type="email" class="form-control" id="parentEmail" required>
              </div>
              <button type="submit" class="btn btn-primary">Add Student</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Student Modal -->
    <div class="modal fade" id="editStudentModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Student</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="editStudentForm">
              <input type="hidden" id="editStudentId">
              <div class="mb-3">
                <label for="editStudentName" class="form-label">Student Name</label>
                <input type="text" class="form-control" id="editStudentName" required>
              </div>
              <div class="mb-3">
                <label for="editStudentIdNumber" class="form-label">Student ID</label>
                <input type="text" class="form-control" id="editStudentIdNumber" required>
              </div>
              <div class="mb-3">
                <label for="editParentPhone" class="form-label">Parent Phone</label>
                <input type="tel" class="form-control" id="editParentPhone" required>
              </div>
              <div class="mb-3">
                <label for="editParentEmail" class="form-label">Parent Email</label>
                <input type="email" class="form-control" id="editParentEmail" required>
              </div>
              <button type="submit" class="btn btn-warning">Update Student</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal fade" id="addTaskModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add New Task</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="addTaskForm">
              <div class="mb-3">
                <label for="taskTitle" class="form-label">Task Title</label>
                <input type="text" class="form-control" id="taskTitle" required>
              </div>
              <div class="mb-3">
                <label for="taskType" class="form-label">Task Type</label>
                <select class="form-control" id="taskType" required>
                  <option value="">Select Type</option>
                  <option value="Assignment">Assignment</option>
                  <option value="Quiz">Quiz</option>
                  <option value="Exam">Exam</option>
                  <option value="Project">Project</option>
                  <option value="Homework">Homework</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="taskDeadline" class="form-label">Deadline</label>
                <input type="datetime-local" class="form-control" id="taskDeadline" required>
              </div>
              <div class="mb-3">
                <label for="taskPerfectScore" class="form-label">Perfect Score</label>
                <input type="number" class="form-control" id="taskPerfectScore" min="1" max="1000" value="100" required>
              </div>
              <div class="mb-3">
                <label for="taskDescription" class="form-label">Description</label>
                <textarea class="form-control" id="taskDescription" rows="3"></textarea>
              </div>
              
              <!-- Rubrics Section -->
              <div class="mb-3">
                <label class="form-label">Rubrics (Optional)</label>
                <div id="rubrics-container">
                  <div class="rubric-item mb-2">
                    <div class="row g-2">
                      <div class="col-8">
                        <input type="text" class="form-control" placeholder="Criteria (e.g., Content, Grammar)" name="rubric-criteria">
                      </div>
                      <div class="col-3">
                        <input type="number" class="form-control" placeholder="Points" min="1" name="rubric-points">
                      </div>
                      <div class="col-1">
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeRubric(this)">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="add-rubric-btn">
                  <i class="bi bi-plus"></i> Add Rubric
                </button>
              </div>
              
              <button type="submit" class="btn btn-info">Create Task</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Send Message Modal -->
    <div class="modal fade" id="sendMessageModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Send Message</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="sendMessageForm">
              <div class="mb-3">
                <label for="messageSubject" class="form-label">Subject</label>
                <input type="text" class="form-control" id="messageSubject" required>
              </div>
              <div class="mb-3">
                <label for="messageRecipient" class="form-label">Send To</label>
                <select class="form-control" id="messageRecipient" required>
                  <option value="all">All Parents</option>
                  <option value="specific">Specific Parent</option>
                </select>
              </div>
              <div class="mb-3" id="specificParentDiv" style="display: none;">
                <label for="specificParent" class="form-label">Select Parent</label>
                <select class="form-control" id="specificParent">
                  <option value="">Loading parents...</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="messageContent" class="form-label">Message</label>
                <textarea class="form-control" id="messageContent" rows="4" required></textarea>
              </div>
              <button type="submit" class="btn btn-warning">Send Message</button>
            </form>
          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- Section Export to Excel Modal -->
  <div class="modal fade" id="sectionExportModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-file-earmark-excel"></i> Export Attendance to Excel</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted">Select the date range for your attendance export</p>
          <div class="mb-3">
            <label for="sectionExportStartDate" class="form-label">Start Date</label>
            <input type="date" class="form-control" id="sectionExportStartDate" required>
          </div>
          <div class="mb-3">
            <label for="sectionExportEndDate" class="form-label">End Date</label>
            <input type="date" class="form-control" id="sectionExportEndDate" required>
          </div>
          <div class="alert alert-info small">
            <i class="bi bi-info-circle"></i> Excel format: First column = Student Name, remaining columns = Dates with attendance status
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="sectionConfirmExportBtn">
            <i class="bi bi-download"></i> Download Excel
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Message Replies Modal -->
  <div class="modal fade" id="messageRepliesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-chat-dots"></i> Message Replies</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- Original Message (Pinned) -->
          <div class="card border-primary mb-3">
            <div class="card-header bg-primary text-white">
              <strong>Original Message</strong>
            </div>
            <div class="card-body">
              <h6 class="card-title" id="originalSubject"></h6>
              <p class="card-text" id="originalMessage"></p>
              <small class="text-muted" id="originalTimestamp"></small>
            </div>
          </div>

          <!-- Replies Thread -->
          <div id="repliesThread">
            <!-- Replies will be dynamically loaded here -->
          </div>

          <!-- Reply Input Form -->
          <div class="card mt-3">
            <div class="card-body">
              <h6 class="card-title"><i class="bi bi-reply"></i> Add Reply</h6>
              <form id="replyForm">
                <div class="mb-3">
                  <textarea class="form-control" id="replyContent" rows="3" placeholder="Type your reply..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-send"></i> Send Reply
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vendor JS Files -->
  <script src="../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    import { auth, db } from "./js/firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { collection, query, where, getDocs, addDoc, doc, getDoc, setDoc, serverTimestamp, updateDoc, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { showLoading, hideLoading, showAlert, confirmModal } from "./js/ui.js";
    import { registerMessaging } from "./js/fcm.js";

    let currentSectionId = null;
    let currentSectionData = null;
    let currentUserUid = null;
    let existingStudents = []; // Cache for duplicate checking

    // Real-time validation functions
    function validateStudentName(name) {
      const nameExists = existingStudents.some(student => 
        student.name.toLowerCase() === name.toLowerCase()
      );
      const nameInput = document.getElementById('studentName');
      const feedback = document.getElementById('studentNameFeedback');
      
      if (name && nameExists) {
        nameInput.classList.add('is-invalid');
        nameInput.classList.remove('is-valid');
        feedback.textContent = `A student named "${name}" already exists in this section.`;
        return false;
      } else if (name) {
        nameInput.classList.add('is-valid');
        nameInput.classList.remove('is-invalid');
        feedback.textContent = '';
        return true;
      } else {
        nameInput.classList.remove('is-valid', 'is-invalid');
        feedback.textContent = '';
        return false;
      }
    }

    function validateStudentId(studentId) {
      const idExists = existingStudents.some(student => 
        student.studentId.toLowerCase() === studentId.toLowerCase()
      );
      const idInput = document.getElementById('studentId');
      const feedback = document.getElementById('studentIdFeedback');
      
      if (studentId && idExists) {
        idInput.classList.add('is-invalid');
        idInput.classList.remove('is-valid');
        feedback.textContent = `Student ID "${studentId}" already exists in this section.`;
        return false;
      } else if (studentId) {
        idInput.classList.add('is-valid');
        idInput.classList.remove('is-invalid');
        feedback.textContent = '';
        return true;
      } else {
        idInput.classList.remove('is-valid', 'is-invalid');
        feedback.textContent = '';
        return false;
      }
    }

    // Get section ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    currentSectionId = urlParams.get('sectionId');

    if (!currentSectionId) {
      window.location.replace('dashboard.html');
    }

    // Load section information
    async function loadSectionInfo() {
      try {
        const sectionDoc = await getDoc(doc(db, 'sections', currentSectionId));
        if (sectionDoc.exists()) {
          currentSectionData = { id: sectionDoc.id, ...sectionDoc.data() };
          
          // Update header
          document.getElementById('section-title').textContent = currentSectionData.name;
          document.getElementById('section-subtitle').textContent = `Grade ${currentSectionData.grade}`;
          document.getElementById('section-breadcrumb').textContent = currentSectionData.name;
          
          // Update stats (will be loaded by individual tab functions)
          document.getElementById('section-stats').style.display = 'flex';
          
          return currentSectionData;
        } else {
          throw new Error('Section not found');
        }
      } catch (error) {
        console.error('Error loading section:', error);
        showAlert('Error loading section information', 'danger');
        setTimeout(() => window.location.replace('dashboard.html'), 2000);
      }
    }

    // Load students content
    async function loadStudentsContent() {
      try {
        const studentsQuery = query(
          collection(db, 'students'),
          where('sectionId', '==', currentSectionId),
          where('ownerUid', '==', currentUserUid)
        );
        const studentsSnapshot = await getDocs(studentsQuery);
        
        // Update existingStudents cache for duplicate checking
        existingStudents = studentsSnapshot.docs.map(doc => doc.data());
        
        const studentsHtml = `
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th><i class="bi bi-person me-2"></i>Name</th>
                  <th><i class="bi bi-card-text me-2"></i>Student ID</th>
                  <th><i class="bi bi-mortarboard me-2"></i>Grade</th>
                  <th><i class="bi bi-telephone me-2"></i>Parent Phone</th>
                  <th><i class="bi bi-envelope me-2"></i>Parent Email</th>
                  <th><i class="bi bi-gear me-2"></i>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${studentsSnapshot.docs.map((doc, index) => {
                  const student = doc.data();
                  return `
                    <tr>
                      <td>
                        <div class="d-flex align-items-center">
                          <div class="avatar-circle me-3" style="width: 40px; height: 40px; background: linear-gradient(135deg, #71c55d, #5ba649); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                            ${student.name.charAt(0).toUpperCase()}
                          </div>
                          <div>
                            <strong class="d-block">${student.name}</strong>
                            <small class="text-muted">Student #${index + 1}</small>
                          </div>
                        </div>
                      </td>
                      <td>
                        <span class="badge bg-light text-dark border">${student.studentId}</span>
                      </td>
                      <td>
                        <span class="badge bg-primary">${student.grade}</span>
                      </td>
                      <td>
                        <div class="d-flex align-items-center">
                          <i class="bi bi-phone text-success me-2"></i>
                          <span>${student.parentPhone || '-'}</span>
                          ${student.parentPhone ? `
                            <button class="btn btn-sm btn-link text-success ms-2 p-0" onclick="window.open('tel:${student.parentPhone}')" title="Call Parent">
                              <i class="bi bi-telephone-fill"></i>
                            </button>
                          ` : ''}
                        </div>
                      </td>
                      <td>
                        <div class="d-flex align-items-center">
                          <i class="bi bi-envelope text-info me-2"></i>
                          <span class="text-truncate" style="max-width: 150px;">${student.parentEmail || '-'}</span>
                          ${student.parentEmail ? `
                            <button class="btn btn-sm btn-link text-info ms-2 p-0" onclick="window.open('mailto:${student.parentEmail}')" title="Email Parent">
                              <i class="bi bi-envelope-fill"></i>
                            </button>
                          ` : ''}
                        </div>
                      </td>
                      <td>
                        <div class="btn-group" role="group">
                          <button class="btn btn-sm btn-outline-info" onclick="viewStudentProfile('${doc.id}')" title="View Profile">
                            <i class="bi bi-eye"></i>
                          </button>
                          <button class="btn btn-sm btn-outline-warning" onclick="editStudent('${doc.id}')" title="Edit Student">
                            <i class="bi bi-pencil-square"></i>
                          </button>
                          <button class="btn btn-sm btn-outline-danger" onclick="deleteStudent('${doc.id}')" title="Delete Student">
                            <i class="bi bi-trash"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
        
        document.getElementById('students-content').innerHTML = studentsHtml;
        document.getElementById('student-count').textContent = studentsSnapshot.size;
        
      } catch (error) {
        console.error('Error loading students:', error);
        document.getElementById('students-content').innerHTML = '<div class="alert alert-danger">Error loading students</div>';
      }
    }

    // Load attendance content
    let sectionAttendanceLogs = []; // Store all logs for filtering
    
    async function loadAttendanceContent() {
      try {
        const attendanceQuery = query(
          collection(db, 'attendanceSessions'),
          where('sectionId', '==', currentSectionId),
          where('ownerUid', '==', currentUserUid)
        );
        const attendanceSnapshot = await getDocs(attendanceQuery);
        
        sectionAttendanceLogs = [];
        attendanceSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.status === 'finalized') {
            sectionAttendanceLogs.push({ id: doc.id, ...data });
          }
        });
        
        // Sort by date descending
        sectionAttendanceLogs.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
        
        // Display all logs initially (will populate month filter inside)
        displaySectionAttendance(sectionAttendanceLogs);
        
      } catch (error) {
        console.error('Error loading attendance:', error);
        document.getElementById('attendance-content').innerHTML = '<div class="alert alert-danger">Error loading attendance</div>';
      }
    }

    // Populate month filter dropdown
    function populateSectionMonthFilter(logs) {
      const monthFilter = document.getElementById('sectionMonthFilter');
      if (!monthFilter) return;
      
      const months = new Set();
      logs.forEach(log => {
        if (log.date) {
          const date = new Date(log.date);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          months.add(monthKey);
        }
      });
      
      const sortedMonths = Array.from(months).sort().reverse();
      monthFilter.innerHTML = '<option value="all">All Months</option>';
      
      sortedMonths.forEach(monthKey => {
        const [year, month] = monthKey.split('-');
        const date = new Date(year, parseInt(month) - 1);
        const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        const option = document.createElement('option');
        option.value = monthKey;
        option.textContent = monthName;
        monthFilter.appendChild(option);
      });
    }

    // Display section attendance
    function displaySectionAttendance(logs) {
      const attendanceHtml = `
        <div class="row mb-3">
          <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
              <h5>Recent Attendance Sessions</h5>
              <div class="d-flex gap-2">
                <select id="sectionMonthFilter" class="form-select form-select-sm" style="width: auto;">
                  <option value="all">All Months</option>
                </select>
                <button class="btn btn-success btn-sm" id="sectionExportExcelBtn" data-bs-toggle="modal" data-bs-target="#sectionExportModal">
                  <i class="bi bi-file-earmark-excel"></i> Export to Excel
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-12">
            ${logs.length === 0 ? 
              '<div class="alert alert-info">No attendance sessions yet. Click "Start Attendance" to begin!</div>' :
              `<div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>Date</th>
                      <th>Status</th>
                      <th>Present</th>
                      <th>Absent</th>
                      <th>Late</th>
                      <th>Cutting</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${logs.map(session => {
                      const date = session.startTime ? new Date(session.startTime.seconds * 1000) : new Date();
                      const attendance = session.studentAttendance || {};
                      const presentCount = Object.values(attendance).filter(s => (s.finalStatus || s.timeInStatus) === 'present').length;
                      const absentCount = Object.values(attendance).filter(s => (s.finalStatus || s.timeInStatus) === 'absent').length;
                      const lateCount = Object.values(attendance).filter(s => (s.finalStatus || s.timeInStatus) === 'late').length;
                      const cuttingCount = Object.values(attendance).filter(s => (s.finalStatus || s.timeInStatus) === 'cutting').length;
                      
                      return `
                        <tr>
                          <td>${date.toLocaleDateString()}</td>
                          <td><span class="badge ${session.status === 'finalized' ? 'bg-success' : 'bg-warning'}">${session.status === 'finalized' ? 'Recorded' : 'In Progress'}</span></td>
                          <td><span class="badge bg-success">${presentCount}</span></td>
                          <td><span class="badge bg-danger">${absentCount}</span></td>
                          <td><span class="badge bg-warning">${lateCount}</span></td>
                          <td><span class="badge bg-dark">${cuttingCount}</span></td>
                          <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewAttendance('${session.id}')">
                              <i class="bi bi-eye"></i>
                            </button>
                          </td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>`
            }
          </div>
        </div>
      `;
      
      document.getElementById('attendance-content').innerHTML = attendanceHtml;
      
      // Populate month filter with all logs (not filtered)
      populateSectionMonthFilter(sectionAttendanceLogs);
      
      // Re-attach month filter event listener
      const monthFilter = document.getElementById('sectionMonthFilter');
      if (monthFilter) {
        // Remove existing listener to prevent duplicates
        const newMonthFilter = monthFilter.cloneNode(true);
        monthFilter.parentNode.replaceChild(newMonthFilter, monthFilter);
        
        newMonthFilter.addEventListener('change', function() {
          const selectedMonth = this.value;
          if (selectedMonth === 'all') {
            displaySectionAttendance(sectionAttendanceLogs);
          } else {
            const filtered = sectionAttendanceLogs.filter(log => {
              if (!log.date) return false;
              const logDate = new Date(log.date);
              const logMonth = `${logDate.getFullYear()}-${String(logDate.getMonth() + 1).padStart(2, '0')}`;
              return logMonth === selectedMonth;
            });
            displaySectionAttendance(filtered);
          }
        });
      }
    }

    // Export section attendance to Excel
    async function exportSectionToExcel(startDate, endDate) {
      try {
        showLoading('Preparing Excel export...');
        
        // Filter logs by date range
        const filtered = sectionAttendanceLogs.filter(log => {
          if (!log.date) return false;
          const logDate = new Date(log.date);
          const start = new Date(startDate);
          const end = new Date(endDate);
          return logDate >= start && logDate <= end;
        });

        if (filtered.length === 0) {
          showAlert('No attendance records found in the selected date range', 'warning');
          return;
        }

        // Sort logs by date ascending for Excel
        filtered.sort((a, b) => new Date(a.date) - new Date(b.date));

        // Get all unique students across all sessions
        const studentMap = new Map();
        filtered.forEach(log => {
          const attendance = log.studentAttendance || {};
          Object.values(attendance).forEach(record => {
            if (!studentMap.has(record.studentId)) {
              studentMap.set(record.studentId, record.studentName);
            }
          });
        });

        // Build Excel data
        const excelData = [];
        
        // Header row: Student Name, then dates
        const headerRow = ['Student Name'];
        filtered.forEach(log => {
          headerRow.push(new Date(log.date).toLocaleDateString());
        });
        excelData.push(headerRow);

        // Data rows: each student
        studentMap.forEach((studentName, studentId) => {
          const row = [studentName];
          filtered.forEach(log => {
            const attendance = log.studentAttendance || {};
            const record = Object.values(attendance).find(r => r.studentId === studentId);
            const status = record ? record.finalStatus.charAt(0).toUpperCase() + record.finalStatus.slice(1) : '-';
            row.push(status);
          });
          excelData.push(row);
        });

        // Create workbook and worksheet
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);

        // Set column widths
        const colWidths = [{ wch: 25 }]; // Student name column
        filtered.forEach(() => colWidths.push({ wch: 12 })); // Date columns
        ws['!cols'] = colWidths;

        // Add worksheet to workbook
        XLSX.utils.book_append_sheet(wb, ws, 'Attendance');

        // Generate filename
        const sectionName = currentSectionData ? currentSectionData.name.replace(/[^a-zA-Z0-9]/g, '_') : 'Section';
        const filename = `Attendance_${sectionName}_${startDate}_to_${endDate}.xlsx`;

        // Download file
        XLSX.writeFile(wb, filename);

        showAlert('Excel file downloaded successfully!', 'success');
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('sectionExportModal'));
        if (modal) modal.hide();

      } catch (err) {
        console.error('Error exporting to Excel:', err);
        showAlert(`Error exporting: ${err.message}`, 'danger');
      } finally {
        hideLoading();
      }
    }

    // Load tasks content
    async function loadTasksContent() {
      try {
        const tasksQuery = query(
          collection(db, 'tasks'),
          where('sectionId', '==', currentSectionId),
          where('ownerUid', '==', currentUserUid)
        );
        const tasksSnapshot = await getDocs(tasksQuery);
        
        // Task type configuration
        const taskTypeConfig = {
          'Assignment': { color: 'primary', icon: 'bi-pencil-square', bgGradient: 'linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%)' },
          'Quiz': { color: 'info', icon: 'bi-question-circle', bgGradient: 'linear-gradient(135deg, #0dcaf0 0%, #0aa2c0 100%)' },
          'Exam': { color: 'danger', icon: 'bi-file-earmark-text', bgGradient: 'linear-gradient(135deg, #dc3545 0%, #bb2d3b 100%)' },
          'Project': { color: 'warning', icon: 'bi-diagram-3', bgGradient: 'linear-gradient(135deg, #ffc107 0%, #cc9a06 100%)' },
          'Homework': { color: 'success', icon: 'bi-book', bgGradient: 'linear-gradient(135deg, #198754 0%, #146c43 100%)' }
        };
        
        // Group tasks by type
        const tasksByType = {};
        tasksSnapshot.docs.forEach(doc => {
          const task = doc.data();
          const taskType = task.type || 'Other';
          if (!tasksByType[taskType]) {
            tasksByType[taskType] = [];
          }
          tasksByType[taskType].push({ id: doc.id, ...task });
        });
        
        // Define the order of task types
        const typeOrder = ['Assignment', 'Quiz', 'Exam', 'Project', 'Homework', 'Other'];
        
        let tasksHtml = '';
        
        if (tasksSnapshot.size === 0) {
          tasksHtml = '<div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>No tasks assigned yet. Click "Add Task" to create one!</div>';
        } else {
          // Generate HTML for each task type group
          typeOrder.forEach(taskType => {
            if (tasksByType[taskType] && tasksByType[taskType].length > 0) {
              const typeStyle = taskTypeConfig[taskType] || { color: 'secondary', icon: 'bi-check-circle', bgGradient: 'linear-gradient(135deg, #6c757d 0%, #565e64 100%)' };
              
              tasksHtml += `
                <div class="mb-4">
                  <div class="d-flex align-items-center mb-3">
                    <div class="rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background: ${typeStyle.bgGradient};">
                      <i class="bi ${typeStyle.icon} text-white fs-5"></i>
                    </div>
                    <h5 class="mb-0">${taskType} <span class="badge bg-${typeStyle.color}">${tasksByType[taskType].length}</span></h5>
                  </div>
                  <div class="row">
                    ${tasksByType[taskType].map(task => {
                      const dueDate = task.deadline ? (task.deadline.toDate ? task.deadline.toDate() : new Date(task.deadline)) : null;
                      const perfectScore = task.perfectScore || 100;
                      const isOverdue = dueDate && dueDate < new Date();
                      const daysDue = dueDate ? Math.ceil((dueDate - new Date()) / (1000 * 60 * 60 * 24)) : null;
                      
                      return `
                        <div class="col-md-6 col-lg-4 mb-4">
                          <div class="card section-card h-100" style="border-left: 4px solid var(--bs-${typeStyle.color});">
                            <div class="card-header" style="background: ${typeStyle.bgGradient}; color: white;">
                              <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 fw-bold text-white">${task.title}</h6>
                                <span class="badge bg-white text-dark">
                                  <i class="bi ${typeStyle.icon} me-1"></i>${taskType}
                                </span>
                              </div>
                            </div>
                            <div class="card-body">
                              <p class="card-text text-muted mb-3">${task.description || 'No description provided'}</p>
                              
                              <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                  <small class="text-muted d-block">Perfect Score</small>
                                  <span class="badge bg-success fs-6">${perfectScore} pts</span>
                                </div>
                                ${task.rubrics && task.rubrics.length > 0 ? 
                                  `<div class="text-end">
                                    <small class="text-muted d-block">Rubrics</small>
                                    <span class="badge bg-info">${task.rubrics.length} criteria</span>
                                  </div>` : ''
                                }
                              </div>
                              
                              ${dueDate ? `
                                <div class="deadline-info p-2 rounded mb-3" style="background: ${isOverdue ? 'rgba(220, 53, 69, 0.1)' : daysDue <= 3 ? 'rgba(255, 193, 7, 0.1)' : 'rgba(40, 167, 69, 0.1)'}">
                                  <div class="d-flex align-items-center">
                                    <i class="bi bi-calendar-event me-2 ${isOverdue ? 'text-danger' : daysDue <= 3 ? 'text-warning' : 'text-success'}"></i>
                                    <div>
                                      <small class="d-block text-muted">Due Date</small>
                                      <strong class="${isOverdue ? 'text-danger' : daysDue <= 3 ? 'text-warning' : 'text-success'}">
                                        ${dueDate.toLocaleDateString()}
                                        ${isOverdue ? ' (Overdue)' : daysDue <= 3 ? ` (${daysDue} days left)` : ''}
                                      </strong>
                                    </div>
                                  </div>
                                </div>
                              ` : ''}
                            </div>
                            <div class="card-footer">
                              <div class="d-grid gap-2">
                                <a href="task-details.html?sectionId=${currentSectionId}&taskId=${task.id}" class="btn btn-primary">
                                  <i class="bi bi-clipboard-check me-2"></i>Grade Task
                                </a>
                                <div class="btn-group" role="group">
                                  <button class="btn btn-outline-secondary" onclick="editTask('${task.id}')" title="Edit Task">
                                    <i class="bi bi-pencil-square"></i>
                                  </button>
                                  <button class="btn btn-outline-warning" onclick="duplicateTask('${task.id}')" title="Duplicate Task">
                                    <i class="bi bi-files"></i>
                                  </button>
                                  <button class="btn btn-outline-danger" onclick="deleteTask('${task.id}')" title="Delete Task">
                                    <i class="bi bi-trash"></i>
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
              `;
            }
          });
        }
        
        document.getElementById('tasks-content').innerHTML = tasksHtml;
        document.getElementById('task-count').textContent = tasksSnapshot.size;
        
      } catch (error) {
        console.error('Error loading tasks:', error);
        document.getElementById('tasks-content').innerHTML = '<div class="alert alert-danger">Error loading tasks</div>';
      }
    }

    // Load messages content
    async function loadMessagesContent() {
      try {
        const messagesQuery = query(
          collection(db, 'messages'),
          where('sectionId', '==', currentSectionId),
          where('ownerUid', '==', currentUserUid)
        );
        const messagesSnapshot = await getDocs(messagesQuery);
        
        const messagesHtml = `
          <div class="row">
            ${messagesSnapshot.size === 0 ?
              '<div class="col-12"><div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>No messages sent yet. Click "Send Message" to communicate with parents!</div></div>' :
              messagesSnapshot.docs.map(doc => {
                const message = doc.data();
                const sentDate = message.createdAt ? new Date(message.createdAt.seconds * 1000) : new Date();
                const timeAgo = getTimeAgo(sentDate);
                return `
                  <div class="col-12 mb-3">
                    <div class="card section-card">
                      <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                          <h6 class="mb-0 fw-bold">
                            <i class="bi bi-envelope me-2"></i>${message.subject || 'No Subject'}
                          </h6>
                          <div class="d-flex align-items-center">
                            <small class="text-light me-3">
                              <i class="bi bi-clock me-1"></i>${timeAgo}
                            </small>
                            <div class="dropdown">
                              <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots"></i>
                              </button>
                              <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="resendMessage('${doc.id}')"><i class="bi bi-arrow-repeat me-2"></i>Resend</a></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteMessage('${doc.id}')"><i class="bi bi-trash me-2"></i>Delete</a></li>
                              </ul>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="card-body">
                        <div class="mb-3">
                          <span class="badge ${message.recipientType === 'all' ? 'bg-success' : 'bg-info'}">
                            <i class="bi bi-people me-1"></i>
                            ${message.recipientType === 'all' ? 'All Parents' : 'Specific Parent'}
                          </span>
                        </div>
                        <p class="card-text">${message.message}</p>
                      </div>
                      <div class="card-footer">
                        <div class="d-flex justify-content-between align-items-center">
                          <small class="text-muted">
                            <i class="bi bi-calendar3 me-1"></i>
                            Sent on ${sentDate.toLocaleDateString()} at ${sentDate.toLocaleTimeString()}
                          </small>
                          <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" onclick="viewMessageDetails('${doc.id}')" title="View Details">
                              <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-success" onclick="viewMessageReplies('${doc.id}')" title="View Replies">
                              <i class="bi bi-chat-dots"></i>
                              ${message.replies && message.replies.length > 0 ? `<span class="badge bg-success ms-1">${message.replies.length}</span>` : ''}
                            </button>
                            <button class="btn btn-outline-primary" onclick="resendMessage('${doc.id}')" title="Resend">
                              <i class="bi bi-arrow-repeat"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')
            }
          </div>
        `;
        
        document.getElementById('messages-content').innerHTML = messagesHtml;
        document.getElementById('message-count').textContent = messagesSnapshot.size;
        
      } catch (error) {
        console.error('Error loading messages:', error);
        document.getElementById('messages-content').innerHTML = '<div class="alert alert-danger">Error loading messages</div>';
      }
    }

    // Tab switching functionality
    const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');
    tabButtons.forEach(button => {
      button.addEventListener('shown.bs.tab', function(event) {
        const target = event.target.getAttribute('data-bs-target');
        
        switch(target) {
          case '#students':
            loadStudentsContent();
            break;
          case '#attendance':
            loadAttendanceContent();
            break;
          case '#tasks':
            loadTasksContent();
            break;
          case '#messages':
            loadMessagesContent();
            break;
        }
      });
    });

    // Add student form handler
    document.getElementById('addStudentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = e.submitter || e.target.querySelector('button[type="submit"]');
      if (btn) btn.disabled = true;
      
      try {
        const name = document.getElementById('studentName').value.trim();
        const studentId = document.getElementById('studentId').value.trim();
        const parentPhone = document.getElementById('parentPhone').value.trim();
        const parentEmail = document.getElementById('parentEmail').value.trim();

        // Check for duplicate student name and ID in the same section
        const duplicateQuery = query(
          collection(db, 'students'),
          where('sectionId', '==', currentSectionId),
          where('ownerUid', '==', currentUserUid)
        );
        const duplicateSnapshot = await getDocs(duplicateQuery);
        
        const existingStudents = duplicateSnapshot.docs.map(doc => doc.data());
        const nameExists = existingStudents.some(student => 
          student.name.toLowerCase() === name.toLowerCase()
        );
        const idExists = existingStudents.some(student => 
          student.studentId.toLowerCase() === studentId.toLowerCase()
        );
        
        // Use real-time validation results
        const nameValid = validateStudentName(name);
        const idValid = validateStudentId(studentId);
        
        if (!nameValid || !idValid) {
          return; // Stop submission if validation fails
        }

        // Upsert parent by normalized email id
        const normalizedId = (function normalizeEmailToId(email) {
          const s = (email || '').trim().toLowerCase();
          const enc = new TextEncoder().encode(s);
          let binary = '';
          const chunkSize = 0x8000;
          for (let i = 0; i < enc.length; i += chunkSize) {
            binary += String.fromCharCode.apply(null, Array.from(enc.slice(i, i + chunkSize)));
          }
          let b64 = btoa(binary);
          b64 = b64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
          return b64;
        })(parentEmail);
        const parentRef = doc(db, 'parents', normalizedId);
        const parentSnap = await getDoc(parentRef);
        
        // First create the student document to get its Firestore doc ID
        const studentDocRef = await addDoc(collection(db, 'students'), {
          name,
          studentId,
          grade: currentSectionData.grade,
          sectionId: currentSectionId,
          parentId: normalizedId,
          parentPhone,
          parentEmail,
          ownerUid: currentUserUid,
          createdAt: serverTimestamp()
        });
        
        // Now upsert parent and link to the student Firestore doc ID (not the studentId number)
        await setDoc(parentRef, {
          email: parentEmail.trim().toLowerCase(),
          name: parentSnap.exists() ? (parentSnap.data().name || ('Parent of ' + name)) : ('Parent of ' + name),
          phone: parentPhone || null,
          linkedStudentIds: arrayUnion(studentDocRef.id),
          ownerUids: arrayUnion(currentUserUid),
          updatedAt: serverTimestamp()
        }, { merge: true });

        // Update section students list
        const sectionRef = doc(db, 'sections', currentSectionId);
        const sectionDoc = await getDoc(sectionRef);
        const studentsArr = Array.isArray(sectionDoc.data()?.students) ? sectionDoc.data().students : [];
        studentsArr.push({ name, studentId });
        await updateDoc(sectionRef, { students: studentsArr });

        document.querySelector('#addStudentModal .btn-close').click();
        showAlert('Student added successfully!', 'success');
        loadStudentsContent();
        e.target.reset();
        // Clear validation states
        document.getElementById('studentName').classList.remove('is-valid', 'is-invalid');
        document.getElementById('studentId').classList.remove('is-valid', 'is-invalid');
        
      } catch (error) {
        console.error('Error adding student:', error);
        showAlert(error.message, 'danger');
      } finally {
        if (btn) btn.disabled = false;
      }
    });

    // Add real-time validation event listeners
    document.getElementById('studentName').addEventListener('input', function() {
      const name = this.value.trim();
      validateStudentName(name);
    });

    document.getElementById('studentId').addEventListener('input', function() {
      const studentId = this.value.trim();
      validateStudentId(studentId);
    });

    // Clear validation when modal is closed
    document.getElementById('addStudentModal').addEventListener('hidden.bs.modal', function() {
      document.getElementById('studentName').classList.remove('is-valid', 'is-invalid');
      document.getElementById('studentId').classList.remove('is-valid', 'is-invalid');
      document.getElementById('studentNameFeedback').textContent = '';
      document.getElementById('studentIdFeedback').textContent = '';
    });

    // Edit Student Form Handler
    document.getElementById('editStudentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = e.submitter || e.target.querySelector('button[type="submit"]');
      if (btn) btn.disabled = true;
      
      try {
        showLoading('Updating student...');
        
        const studentDocId = document.getElementById('editStudentId').value;
        const name = document.getElementById('editStudentName').value.trim();
        const studentId = document.getElementById('editStudentIdNumber').value.trim();
        const parentPhone = document.getElementById('editParentPhone').value.trim();
        const parentEmail = document.getElementById('editParentEmail').value.trim();
        
        // Get the current student data to check if email changed
        const currentStudentDoc = await getDoc(doc(db, 'students', studentDocId));
        const currentStudent = currentStudentDoc.data();
        const emailChanged = currentStudent.parentEmail !== parentEmail;
        
        // Update student document
        const studentRef = doc(db, 'students', studentDocId);
        await updateDoc(studentRef, {
          name,
          studentId,
          parentPhone,
          parentEmail,
          updatedAt: serverTimestamp()
        });
        
        // If email changed, update parent linking
        if (emailChanged) {
          const oldNormalizedId = currentStudent.parentId;
          const newNormalizedId = (function normalizeEmailToId(email) {
            const s = (email || '').trim().toLowerCase();
            const enc = new TextEncoder().encode(s);
            let binary = '';
            const chunkSize = 0x8000;
            for (let i = 0; i < enc.length; i += chunkSize) {
              binary += String.fromCharCode.apply(null, Array.from(enc.slice(i, i + chunkSize)));
            }
            let b64 = btoa(binary);
            b64 = b64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
            return b64;
          })(parentEmail);
          
          // Remove student from old parent's linkedStudentIds
          if (oldNormalizedId) {
            const oldParentRef = doc(db, 'parents', oldNormalizedId);
            const oldParentSnap = await getDoc(oldParentRef);
            if (oldParentSnap.exists()) {
              const linkedIds = oldParentSnap.data().linkedStudentIds || [];
              const updatedIds = linkedIds.filter(id => id !== studentDocId);
              await updateDoc(oldParentRef, {
                linkedStudentIds: updatedIds,
                updatedAt: serverTimestamp()
              });
            }
          }
          
          // Add student to new parent
          const newParentRef = doc(db, 'parents', newNormalizedId);
          const newParentSnap = await getDoc(newParentRef);
          
          await setDoc(newParentRef, {
            email: parentEmail.trim().toLowerCase(),
            name: newParentSnap.exists() ? (newParentSnap.data().name || ('Parent of ' + name)) : ('Parent of ' + name),
            phone: parentPhone || null,
            linkedStudentIds: arrayUnion(studentDocId),
            ownerUids: arrayUnion(currentUserUid),
            updatedAt: serverTimestamp()
          }, { merge: true });
          
          // Update student's parentId reference
          await updateDoc(studentRef, {
            parentId: newNormalizedId
          });
        } else {
          // Just update the parent phone if email didn't change
          const normalizedId = currentStudent.parentId;
          if (normalizedId) {
            const parentRef = doc(db, 'parents', normalizedId);
            await updateDoc(parentRef, {
              phone: parentPhone || null,
              updatedAt: serverTimestamp()
            });
          }
        }
        
        // Update section students list
        const sectionRef = doc(db, 'sections', currentSectionId);
        const sectionDoc = await getDoc(sectionRef);
        const studentsArr = sectionDoc.data().students || [];
        const studentIndex = studentsArr.findIndex(s => s.studentId === currentStudent.studentId);
        
        if (studentIndex !== -1) {
          studentsArr[studentIndex] = { name, studentId };
          await updateDoc(sectionRef, { students: studentsArr });
        }
        
        hideLoading();
        document.querySelector('#editStudentModal .btn-close').click();
        showAlert('Student updated successfully!', 'success');
        await loadStudentsContent();
        
      } catch (error) {
        hideLoading();
        console.error('Error updating student:', error);
        showAlert('Error updating student: ' + error.message, 'danger');
      } finally {
        if (btn) btn.disabled = false;
      }
    });

    // Rubrics management functions
    window.removeRubric = function(button) {
      const rubricItem = button.closest('.rubric-item');
      const container = document.getElementById('rubrics-container');
      if (container.children.length > 1) {
        rubricItem.remove();
      } else {
        showAlert('At least one rubric item is required', 'warning');
      }
    };

    function addRubricItem() {
      const container = document.getElementById('rubrics-container');
      const rubricHtml = `
        <div class="rubric-item mb-2">
          <div class="row g-2">
            <div class="col-8">
              <input type="text" class="form-control" placeholder="Criteria (e.g., Content, Grammar)" name="rubric-criteria">
            </div>
            <div class="col-3">
              <input type="number" class="form-control" placeholder="Points" min="1" name="rubric-points">
            </div>
            <div class="col-1">
              <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeRubric(this)">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', rubricHtml);
    }

    document.getElementById('add-rubric-btn').addEventListener('click', addRubricItem);

    // Add task form handler
    document.getElementById('addTaskForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = e.submitter || e.target.querySelector('button[type="submit"]');
      if (btn) btn.disabled = true;
      
      try {
        const title = document.getElementById('taskTitle').value.trim();
        const type = document.getElementById('taskType').value;
        const deadline = document.getElementById('taskDeadline').value;
        const perfectScore = parseInt(document.getElementById('taskPerfectScore').value);
        const description = document.getElementById('taskDescription').value.trim();

        // Collect rubrics
        const rubrics = [];
        const rubricItems = document.querySelectorAll('.rubric-item');
        let totalRubricPoints = 0;
        
        rubricItems.forEach(item => {
          const criteria = item.querySelector('input[name="rubric-criteria"]').value.trim();
          const points = parseInt(item.querySelector('input[name="rubric-points"]').value) || 0;
          
          if (criteria && points > 0) {
            rubrics.push({ criteria, points });
            totalRubricPoints += points;
          }
        });

        // Validate rubrics if provided
        if (rubrics.length > 0 && totalRubricPoints !== perfectScore) {
          throw new Error(`Rubric points total (${totalRubricPoints}) must equal perfect score (${perfectScore})`);
        }

        const taskDoc = await addDoc(collection(db, 'tasks'), {
          title,
          type,
          deadline: deadline ? new Date(deadline) : null,
          perfectScore,
          rubrics,
          description,
          sectionId: currentSectionId,
          ownerUid: currentUserUid,
          createdAt: serverTimestamp()
        });

        document.querySelector('#addTaskModal .btn-close').click();
        e.target.reset();
        
        // Reset rubrics to default state
        const container = document.getElementById('rubrics-container');
        container.innerHTML = `
          <div class="rubric-item mb-2">
            <div class="row g-2">
              <div class="col-8">
                <input type="text" class="form-control" placeholder="Criteria (e.g., Content, Grammar)" name="rubric-criteria">
              </div>
              <div class="col-3">
                <input type="number" class="form-control" placeholder="Points" min="1" name="rubric-points">
              </div>
              <div class="col-1">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeRubric(this)">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `;
        
        showAlert('Task created successfully! Redirecting to task details...', 'success');
        
        // Redirect to task details page
        setTimeout(() => {
          window.location.href = `task-details.html?sectionId=${currentSectionId}&taskId=${taskDoc.id}`;
        }, 1500);
        
      } catch (error) {
        console.error('Error adding task:', error);
        showAlert(error.message, 'danger');
      } finally {
        if (btn) btn.disabled = false;
      }
    });

    // Send message form handler
    document.getElementById('sendMessageForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = e.submitter || e.target.querySelector('button[type="submit"]');
      if (btn) btn.disabled = true;
      
      try {
        const subject = document.getElementById('messageSubject').value.trim();
        const recipientType = document.getElementById('messageRecipient').value;
        const content = document.getElementById('messageContent').value.trim();

        await addDoc(collection(db, 'messages'), {
          subject,
          message: content,
          recipientType,
          sectionId: currentSectionId,
          ownerUid: currentUserUid,
          createdAt: serverTimestamp()
        });

        document.querySelector('#sendMessageModal .btn-close').click();
        showAlert('Message sent successfully!', 'success');
        loadMessagesContent();
        e.target.reset();
        
      } catch (error) {
        console.error('Error sending message:', error);
        showAlert(error.message, 'danger');
      } finally {
        if (btn) btn.disabled = false;
      }
    });

    // Handle recipient type change for messages
    document.getElementById('messageRecipient').addEventListener('change', function() {
      const specificDiv = document.getElementById('specificParentDiv');
      if (this.value === 'specific') {
        specificDiv.style.display = 'block';
        // Load parents for this section (simplified - you can enhance this)
        loadParentsForMessage();
      } else {
        specificDiv.style.display = 'none';
      }
    });

    // Load parents for message recipient selection
    async function loadParentsForMessage() {
      try {
        const studentsQuery = query(
          collection(db, 'students'),
          where('sectionId', '==', currentSectionId),
          where('ownerUid', '==', currentUserUid)
        );
        const studentsSnapshot = await getDocs(studentsQuery);
        
        const parentsHtml = '<option value="">Select Parent</option>' + 
          studentsSnapshot.docs.map(doc => {
            const student = doc.data();
            return `<option value="${student.parentEmail}">${student.parentEmail} (${student.name})</option>`;
          }).join('');
        
        document.getElementById('specificParent').innerHTML = parentsHtml;
      } catch (error) {
        console.error('Error loading parents:', error);
      }
    }

    // Utility function to get time ago string
    function getTimeAgo(date) {
      const now = new Date();
      const diffInSeconds = Math.floor((now - date) / 1000);
      
      if (diffInSeconds < 60) return 'Just now';
      if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
      if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
      if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}d ago`;
      return date.toLocaleDateString();
    }

    // Message management functions
    window.viewMessageDetails = function(messageId) {
      showAlert('Message details functionality will be implemented soon', 'info');
      // TODO: Implement view message details
    };

    window.resendMessage = function(messageId) {
      showAlert('Resend message functionality will be implemented soon', 'info');
      // TODO: Implement resend message
    };

    window.deleteMessage = async function(messageId) {
      try {
        const confirmed = await confirmModal(
          'Delete Message', 
          'Are you sure you want to delete this message? This action cannot be undone.',
          { confirmText: 'Delete', cancelText: 'Cancel', variant: 'danger' }
        );
        
        if (!confirmed) return;
        
        showLoading('Deleting message...');
        
        await deleteDoc(doc(db, 'messages', messageId));
        
        hideLoading();
        showAlert('Message deleted successfully!', 'success');
        
        // Reload messages content
        await loadMessagesContent();
        
      } catch (error) {
        hideLoading();
        console.error('Error deleting message:', error);
        showAlert('Error deleting message: ' + error.message, 'danger');
      }
    };

    // View message replies
    let currentMessageId = null;
    let repliesListener = null;

    window.viewMessageReplies = async function(messageId) {
      try {
        currentMessageId = messageId;
        showLoading('Loading message replies...');
        
        // Get message document
        const messageDoc = await getDoc(doc(db, 'messages', messageId));
        if (!messageDoc.exists()) {
          throw new Error('Message not found');
        }
        
        const messageData = messageDoc.data();
        
        // Display original message
        document.getElementById('originalSubject').textContent = messageData.subject || 'No Subject';
        document.getElementById('originalMessage').textContent = messageData.message || '';
        document.getElementById('originalTimestamp').textContent = messageData.createdAt 
          ? new Date(messageData.createdAt.seconds * 1000).toLocaleString()
          : 'Unknown date';
        
        // Display replies
        const replies = messageData.replies || [];
        displayReplies(replies);
        
        hideLoading();
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('messageRepliesModal'));
        modal.show();
        
        // Set up real-time listener for new replies
        if (repliesListener) repliesListener(); // Unsubscribe previous listener
        
        const { onSnapshot } = await import("https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js");
        repliesListener = onSnapshot(doc(db, 'messages', messageId), (doc) => {
          if (doc.exists()) {
            const replies = doc.data().replies || [];
            displayReplies(replies);
          }
        });
        
      } catch (error) {
        hideLoading();
        console.error('Error loading message replies:', error);
        showAlert('Error loading message replies: ' + error.message, 'danger');
      }
    };

    function displayReplies(replies) {
      const repliesThread = document.getElementById('repliesThread');
      
      if (replies.length === 0) {
        repliesThread.innerHTML = '<div class="alert alert-info">No replies yet. Be the first to reply!</div>';
        return;
      }
      
      repliesThread.innerHTML = replies.map((reply, index) => {
        const roleClass = reply.role === 'teacher' ? 'primary' : 'success';
        const roleIcon = reply.role === 'teacher' ? 'person-badge' : 'person-check';
        const roleName = reply.role === 'teacher' ? 'Teacher' : 'Parent';
        
        return `
          <div class="card mb-2">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <strong class="text-${roleClass}">
                    <i class="bi bi-${roleIcon}"></i> ${reply.senderName || 'Anonymous'}
                  </strong>
                  <span class="badge bg-${roleClass} ms-2">${roleName}</span>
                </div>
                <small class="text-muted">${new Date(reply.timestamp.seconds * 1000).toLocaleString()}</small>
              </div>
              <p class="mb-0">${reply.content}</p>
            </div>
          </div>
        `;
      }).join('');
    }

    // Handle reply form submission
    document.getElementById('replyForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!currentMessageId) {
        showAlert('No message selected', 'danger');
        return;
      }
      
      try {
        const replyContent = document.getElementById('replyContent').value.trim();
        if (!replyContent) {
          showAlert('Please enter a reply', 'warning');
          return;
        }
        
        showLoading('Sending reply...');
        
        // Get teacher name
        const userDoc = await getDoc(doc(db, 'users', currentUserUid));
        const teacherName = userDoc.exists() ? (userDoc.data().name || auth.currentUser.displayName || 'Teacher') : 'Teacher';
        
        // Import Timestamp
        const { Timestamp } = await import("https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js");
        
        // Create reply object with current timestamp
        const reply = {
          content: replyContent,
          senderName: teacherName,
          senderUid: currentUserUid,
          role: 'teacher',
          timestamp: Timestamp.now()
        };
        
        // Update message document with new reply
        await updateDoc(doc(db, 'messages', currentMessageId), {
          replies: arrayUnion(reply)
        });
        
        hideLoading();
        showAlert('Reply sent successfully!', 'success');
        
        // Clear form
        document.getElementById('replyContent').value = '';
        
        // Replies will update automatically via the real-time listener
        
      } catch (error) {
        hideLoading();
        console.error('Error sending reply:', error);
        showAlert('Error sending reply: ' + error.message, 'danger');
      }
    });

    // Clean up listener when modal is closed
    document.getElementById('messageRepliesModal').addEventListener('hidden.bs.modal', function() {
      if (repliesListener) {
        repliesListener();
        repliesListener = null;
      }
      currentMessageId = null;
      document.getElementById('replyContent').value = '';
    });

    // View attendance function
    window.viewAttendance = function(sessionId) {
      window.location.href = `attendance.html?sectionId=${currentSectionId}&sessionId=${sessionId}`;
    };

    // Student management functions
    window.viewStudentProfile = async function(studentId) {
      try {
        showLoading('Loading student profile...');
        
        const studentDoc = await getDoc(doc(db, 'students', studentId));
        if (!studentDoc.exists()) {
          throw new Error('Student not found');
        }
        
        const student = studentDoc.data();
        
        // Get student's task scores from taskScores collection
        // Each taskScore document has a scores map with studentId as key
        let scores = [];
        try {
          const scoresQuery = query(
            collection(db, 'taskScores'),
            where('sectionId', '==', currentSectionId),
            where('ownerUid', '==', currentUserUid)
          );
          const scoresSnapshot = await getDocs(scoresQuery);
          
          // Extract scores for this specific student from the scores map
          scoresSnapshot.docs.forEach(doc => {
            const taskScore = doc.data();
            // Check if this student has a score in the scores map
            if (taskScore.scores && taskScore.scores[studentId] !== undefined) {
              scores.push({
                id: doc.id,
                taskTitle: taskScore.title || 'Task',
                taskType: taskScore.category || taskScore.type || 'N/A',
                totalScore: taskScore.scores[studentId] || 0,
                perfectScore: taskScore.perfectScore || 100,
                updatedAt: taskScore.updatedAt,
                createdAt: taskScore.createdAt
              });
            }
          });
          
          console.log(`Found ${scores.length} task scores for student ${studentId}`, scores);
        } catch (scoreError) {
          console.warn('Could not load task scores:', scoreError);
          // Continue without scores
        }
        
        hideLoading();
        
        // Create and show student profile modal
        const profileModal = document.createElement('div');
        profileModal.className = 'modal fade';
        profileModal.innerHTML = `
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">
                  <i class="bi bi-person-circle me-2"></i>Student Profile
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="row">
                  <div class="col-md-4 text-center mb-4">
                    <div class="avatar-circle mx-auto mb-3" style="width: 100px; height: 100px; background: linear-gradient(135deg, #71c55d, #5ba649); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 2rem;">
                      ${student.name.charAt(0).toUpperCase()}
                    </div>
                    <h4>${student.name}</h4>
                    <p class="text-muted">${student.studentId}</p>
                  </div>
                  <div class="col-md-8">
                    <div class="row">
                      <div class="col-sm-6 mb-3">
                        <label class="form-label text-muted">Grade Level</label>
                        <div><span class="badge bg-primary fs-6">${student.grade}</span></div>
                      </div>
                      <div class="col-sm-6 mb-3">
                        <label class="form-label text-muted">Section</label>
                        <div>${currentSectionData.name}</div>
                      </div>
                      <div class="col-sm-6 mb-3">
                        <label class="form-label text-muted">Parent Phone</label>
                        <div>${student.parentPhone || 'Not provided'}</div>
                      </div>
                      <div class="col-sm-6 mb-3">
                        <label class="form-label text-muted">Parent Email</label>
                        <div class="text-truncate">${student.parentEmail || 'Not provided'}</div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <hr>
                
                <h6 class="mb-3">
                  <i class="bi bi-graph-up me-2"></i>Academic Performance
                  <span class="badge bg-primary ms-2">${scores.length} Task${scores.length !== 1 ? 's' : ''}</span>
                </h6>
                ${scores.length === 0 ? 
                  '<div class="alert alert-info mb-0"><i class="bi bi-info-circle me-2"></i>No task scores recorded yet. Scores will appear here after grading tasks.</div>' :
                  `
                  ${(() => {
                    const totalScores = scores.reduce((sum, s) => sum + (s.totalScore || 0), 0);
                    const totalPerfect = scores.reduce((sum, s) => sum + (s.perfectScore || 100), 0);
                    const avgPercentage = totalPerfect > 0 ? Math.round((totalScores / totalPerfect) * 100) : 0;
                    const avgColor = avgPercentage >= 90 ? 'success' : avgPercentage >= 75 ? 'warning' : 'danger';
                    
                    return `
                      <div class="alert alert-${avgColor} mb-3 d-flex align-items-center justify-content-between">
                        <div>
                          <strong>Overall Average:</strong>
                          <span class="fs-5 ms-2">${avgPercentage}%</span>
                          <small class="text-muted ms-2">(${totalScores}/${totalPerfect} pts)</small>
                        </div>
                        <i class="bi bi-trophy-fill fs-4"></i>
                      </div>
                    `;
                  })()}
                  
                  <div class="table-responsive">
                    <table class="table table-hover table-sm">
                      <thead class="table-light">
                        <tr>
                          <th>Task</th>
                          <th>Type</th>
                          <th class="text-center">Score</th>
                          <th class="text-center">Percentage</th>
                          <th>Date</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${scores.map((score, index) => {
                          const percentage = score.perfectScore > 0 ? Math.round((score.totalScore / score.perfectScore) * 100) : 0;
                          return `
                            <tr>
                              <td>
                                <strong>${score.taskTitle || 'Task ' + (index + 1)}</strong>
                              </td>
                              <td>
                                <span class="badge bg-secondary">${score.taskType || 'N/A'}</span>
                              </td>
                              <td class="text-center">
                                <strong>${score.totalScore || 0}</strong>/<small>${score.perfectScore || 100}</small>
                              </td>
                              <td class="text-center">
                                <span class="badge ${percentage >= 90 ? 'bg-success' : percentage >= 75 ? 'bg-warning text-dark' : 'bg-danger'}">
                                  ${percentage}%
                                </span>
                              </td>
                              <td>
                                <small class="text-muted">
                                  ${score.updatedAt ? new Date(score.updatedAt.seconds * 1000).toLocaleDateString() : score.createdAt ? new Date(score.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}
                                </small>
                              </td>
                            </tr>
                          `;
                        }).join('')}
                      </tbody>
                    </table>
                  </div>
                  `
                }
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(profileModal);
        const modalInstance = new bootstrap.Modal(profileModal);
        modalInstance.show();
        
        // Clean up modal when hidden
        profileModal.addEventListener('hidden.bs.modal', () => {
          document.body.removeChild(profileModal);
        });
        
      } catch (error) {
        hideLoading();
        console.error('Error loading student profile:', error);
        showAlert('Error loading student profile: ' + error.message, 'danger');
      }
    };

    window.editStudent = async function(studentId) {
      try {
        showLoading('Loading student data...');
        
        const studentDoc = await getDoc(doc(db, 'students', studentId));
        if (!studentDoc.exists()) {
          throw new Error('Student not found');
        }
        
        const student = studentDoc.data();
        
        hideLoading();
        
        // Populate the edit form
        document.getElementById('editStudentId').value = studentId;
        document.getElementById('editStudentName').value = student.name;
        document.getElementById('editStudentIdNumber').value = student.studentId;
        document.getElementById('editParentPhone').value = student.parentPhone || '';
        document.getElementById('editParentEmail').value = student.parentEmail || '';
        
        // Show the edit modal
        const editModal = new bootstrap.Modal(document.getElementById('editStudentModal'));
        editModal.show();
        
      } catch (error) {
        hideLoading();
        console.error('Error loading student for edit:', error);
        showAlert('Error loading student data: ' + error.message, 'danger');
      }
    };

    window.deleteStudent = async function(studentId) {
      try {
        const confirmed = await confirmModal(
          'Delete Student', 
          'Are you sure you want to delete this student? This action cannot be undone.',
          { confirmText: 'Delete', cancelText: 'Cancel', variant: 'danger' }
        );
        
        if (!confirmed) return;
        
        showLoading('Deleting student...');
        
        // Get student data before deletion for section update
        const studentDoc = await getDoc(doc(db, 'students', studentId));
        if (!studentDoc.exists()) {
          throw new Error('Student not found');
        }
        
        const studentData = studentDoc.data();
        
        // Delete the student document
        await deleteDoc(doc(db, 'students', studentId));
        
        // Update section students list (remove from summary)
        const sectionRef = doc(db, 'sections', currentSectionId);
        const sectionDoc = await getDoc(sectionRef);
        if (sectionDoc.exists()) {
          const studentsArr = Array.isArray(sectionDoc.data()?.students) ? sectionDoc.data().students : [];
          const updatedStudents = studentsArr.filter(s => 
            s.studentId !== studentData.studentId || s.name !== studentData.name
          );
          await updateDoc(sectionRef, { students: updatedStudents });
        }
        
        hideLoading();
        showAlert('Student deleted successfully!', 'success');
        
        // Reload students content to refresh the display
        await loadStudentsContent();
        
      } catch (error) {
        hideLoading();
        console.error('Error deleting student:', error);
        showAlert('Error deleting student: ' + error.message, 'danger');
      }
    };

    // Task management functions
    window.duplicateTask = async function(taskId) {
      try {
        const confirmed = await confirmModal(
          'Duplicate Task', 
          'This will create a copy of the task. You can modify it after creation.',
          { confirmText: 'Duplicate', cancelText: 'Cancel', variant: 'primary' }
        );
        
        if (!confirmed) return;
        
        showLoading('Duplicating task...');
        
        // Get original task data
        const originalTaskDoc = await getDoc(doc(db, 'tasks', taskId));
        if (!originalTaskDoc.exists()) {
          throw new Error('Original task not found');
        }
        
        const originalTask = originalTaskDoc.data();
        
        // Create duplicate with modified title
        const duplicateData = {
          ...originalTask,
          title: `${originalTask.title} (Copy)`,
          createdAt: serverTimestamp()
        };
        
        // Remove the ID field if it exists
        delete duplicateData.id;
        
        const newTaskDoc = await addDoc(collection(db, 'tasks'), duplicateData);
        
        hideLoading();
        showAlert('Task duplicated successfully!', 'success');
        
        // Reload tasks content to show the new duplicate
        await loadTasksContent();
        
      } catch (error) {
        hideLoading();
        console.error('Error duplicating task:', error);
        showAlert('Error duplicating task: ' + error.message, 'danger');
      }
    };

    window.editTask = function(taskId) {
      showAlert('Edit task functionality will be implemented soon', 'info');
      // TODO: Implement edit task functionality
    };

    window.deleteTask = async function(taskId) {
      try {
        const confirmed = await confirmModal(
          'Delete Task', 
          'Are you sure you want to delete this task? This action cannot be undone.',
          { confirmText: 'Delete', cancelText: 'Cancel', variant: 'danger' }
        );
        
        if (!confirmed) return;
        
        showLoading('Deleting task...');
        
        // Delete the task document
        await deleteDoc(doc(db, 'tasks', taskId));
        
        hideLoading();
        showAlert('Task deleted successfully!', 'success');
        
        // Reload tasks content to refresh the display
        await loadTasksContent();
        
      } catch (error) {
        hideLoading();
        console.error('Error deleting task:', error);
        showAlert('Error deleting task: ' + error.message, 'danger');
      }
    };

    // Start attendance button handler
    document.getElementById('start-attendance-btn').addEventListener('click', () => {
      window.location.href = `attendance.html?sectionId=${currentSectionId}`;
    });

    // Authentication handler
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.replace('login.html');
        return;
      }

      try {
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (!userDoc.exists() || userDoc.data().role !== 'teacher') {
          await signOut(auth);
          window.location.replace('login.html');
          return;
        }

        currentUserUid = user.uid;
        
        // Display teacher profile info in header
        const userData = userDoc.data();
        const teacherNameEl = document.getElementById('teacherName');
        const teacherPhotoEl = document.getElementById('teacherPhoto');
        
        if (teacherNameEl && userData.name) {
          teacherNameEl.textContent = userData.name;
        } else if (teacherNameEl && user.displayName) {
          teacherNameEl.textContent = user.displayName;
        } else if (teacherNameEl && user.email) {
          teacherNameEl.textContent = user.email.split('@')[0];
        }
        
        if (teacherPhotoEl && (userData.photoURL || user.photoURL)) {
          teacherPhotoEl.src = userData.photoURL || user.photoURL;
          teacherPhotoEl.style.display = 'block';
        }
        
        await registerMessaging(user);
        
        // Load section information and initial content
        await loadSectionInfo();
        await loadStudentsContent(); // Load default tab content
        
      } catch (error) {
        console.error('Authentication error:', error);
        showAlert(error.message, 'danger');
      }
    });

    // Logout handler
    document.getElementById('logout').addEventListener('click', async (e) => {
      e.preventDefault();
      const ok = await confirmModal('Sign out', 'Are you sure you want to log out?', { confirmText: 'Log out', cancelText: 'Stay', variant: 'danger' });
      if (!ok) return;
      showLoading('Signing out');
      await signOut(auth);
      window.location.replace('login.html');
    });

    // Section Export modal handlers
    document.addEventListener('DOMContentLoaded', function() {
      // Set default date range (current month)
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      
      const startDateEl = document.getElementById('sectionExportStartDate');
      const endDateEl = document.getElementById('sectionExportEndDate');
      
      if (startDateEl) startDateEl.value = firstDay.toISOString().split('T')[0];
      if (endDateEl) endDateEl.value = lastDay.toISOString().split('T')[0];

      // Confirm export button
      const confirmBtn = document.getElementById('sectionConfirmExportBtn');
      if (confirmBtn) {
        confirmBtn.addEventListener('click', function() {
          const startDate = document.getElementById('sectionExportStartDate').value;
          const endDate = document.getElementById('sectionExportEndDate').value;
          
          if (!startDate || !endDate) {
            showAlert('Please select both start and end dates', 'warning');
            return;
          }
          
          if (new Date(startDate) > new Date(endDate)) {
            showAlert('Start date must be before or equal to end date', 'warning');
            return;
          }
          
          exportSectionToExcel(startDate, endDate);
        });
      }
    });

  </script>

</body>
</html>